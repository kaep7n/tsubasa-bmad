# Story 1.2: Supabase Project Setup & Schema Initialization

## Status
Draft

## Story
**As a** developer,
**I want** the Supabase project configured with base schema,
**so that** authentication and data storage are ready

## Acceptance Criteria
1. ✅ Supabase project created (free tier)
2. ✅ Supabase CLI installed and initialized
3. ✅ Initial migration file created with `teams` table:
   - `id` (uuid, primary key, default: gen_random_uuid())
   - `name` (text, not null)
   - `season` (text, e.g., "2024-2025")
   - `logo_url` (text, nullable)
   - `created_by` (uuid, foreign key to auth.users)
   - `created_at` (timestamptz, default: now())
   - `updated_at` (timestamptz, default: now())
4. ✅ RLS policies enabled on `teams` table:
   - SELECT: Users can only see teams they created (`created_by = auth.uid()`)
   - INSERT: Users can create teams with their user_id
   - UPDATE: Users can only update teams they own
   - DELETE: Users can only delete teams they own
5. ✅ Migration applied to Supabase project: `supabase db push`
6. ✅ Connection string saved to `.env` file (not committed to Git)
7. ✅ pgTAP tests created for `teams` table schema and RLS policies

## Tasks / Subtasks

- [ ] **Task 1: Install Supabase CLI** (AC: 2)
  - [ ] Install Supabase CLI globally: `npm install -g supabase`
  - [ ] Verify installation: `supabase --version`
  - [ ] Confirm CLI version is 1.x or higher

- [ ] **Task 2: Create Supabase Project** (AC: 1)
  - [ ] Go to https://supabase.com and sign up/login
  - [ ] Create new project named "tsubasa" on free tier
  - [ ] Select closest region for optimal performance
  - [ ] Note down project URL and anon key from Settings > API
  - [ ] Save database password securely (needed for CLI connection)

- [ ] **Task 3: Initialize Supabase in Local Project** (AC: 2)
  - [ ] Navigate to project root directory
  - [ ] Run `supabase init` to create `/supabase` directory structure
  - [ ] Verify `/supabase/config.toml` file created
  - [ ] Link local project to remote: `supabase link --project-ref <project-ref>`
  - [ ] Verify connection with `supabase db remote ls`

- [ ] **Task 4: Create Teams Table Migration** (AC: 3)
  - [ ] Generate new migration file: `supabase migration new create_teams_table`
  - [ ] Add SQL to create `teams` table with exact schema:
    ```sql
    CREATE TABLE teams (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      name TEXT NOT NULL,
      season TEXT,
      logo_url TEXT,
      created_by UUID REFERENCES auth.users(id) NOT NULL,
      created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
      updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
    );
    ```
  - [ ] Add index on `created_by` for RLS performance
  - [ ] Add trigger to auto-update `updated_at` timestamp

- [ ] **Task 5: Configure Row Level Security (RLS) Policies** (AC: 4)
  - [ ] In same migration file, enable RLS on teams table:
    ```sql
    ALTER TABLE teams ENABLE ROW LEVEL SECURITY;
    ```
  - [ ] Create SELECT policy: Users can only see their own teams
    ```sql
    CREATE POLICY "Users can view own teams" ON teams
      FOR SELECT USING (auth.uid() = created_by);
    ```
  - [ ] Create INSERT policy: Users can create teams with their user_id
    ```sql
    CREATE POLICY "Users can create teams" ON teams
      FOR INSERT WITH CHECK (auth.uid() = created_by);
    ```
  - [ ] Create UPDATE policy: Users can only update their own teams
    ```sql
    CREATE POLICY "Users can update own teams" ON teams
      FOR UPDATE USING (auth.uid() = created_by);
    ```
  - [ ] Create DELETE policy: Users can only delete their own teams
    ```sql
    CREATE POLICY "Users can delete own teams" ON teams
      FOR DELETE USING (auth.uid() = created_by);
    ```

- [ ] **Task 6: Apply Migration to Supabase** (AC: 5)
  - [ ] Run `supabase db push` to apply migration to remote database
  - [ ] Verify migration applied successfully
  - [ ] Check Supabase dashboard > Table Editor to confirm `teams` table exists
  - [ ] Verify RLS policies visible in Table Editor > Authentication tab

- [ ] **Task 7: Configure Environment Variables** (AC: 6)
  - [ ] Create `.env` file in project root (if not exists)
  - [ ] Add Supabase connection details:
    ```
    SUPABASE_URL=https://<project-ref>.supabase.co
    SUPABASE_ANON_KEY=<your-anon-key>
    SUPABASE_DB_URL=postgresql://postgres:<password>@db.<project-ref>.supabase.co:5432/postgres
    ```
  - [ ] Verify `.env` is in `.gitignore` (should be from Story 1.1)
  - [ ] Create `.env.example` with placeholder values for team reference

- [ ] **Task 8: Create pgTAP Tests for Schema and RLS** (AC: 7)
  - [ ] Create `/supabase/tests/teams_test.sql` file
  - [ ] Add pgTAP tests for schema validation:
    - Verify `teams` table exists
    - Verify all columns have correct types
    - Verify primary key and foreign key constraints
    - Verify default values and NOT NULL constraints
  - [ ] Add pgTAP tests for RLS policies:
    - Test SELECT policy: User can only see own teams
    - Test INSERT policy: User can only insert with their user_id
    - Test UPDATE policy: User cannot update other users' teams
    - Test DELETE policy: User cannot delete other users' teams
  - [ ] Run tests: `supabase test db`
  - [ ] Verify all tests pass

## Dev Notes

### Previous Story Context
**Dependency:** This story requires Story 1.1 (Project Scaffolding) to be completed first. Specifically:
- The `/supabase/migrations/` directory must exist (created in Story 1.1, Task 4)
- Git repository must be initialized with `.gitignore` (Story 1.1, Task 3)
- The monorepo structure must be in place

### Tech Stack - Database & Backend
This story establishes the Supabase backend infrastructure that will be used throughout the project.

**Backend Technologies:**
- **Supabase Backend-as-a-Service** - Auto-generated REST API from PostgreSQL schema [Source: architecture/3-tech-stack.md]
- **PostgreSQL 14+** - Relational database with ACID compliance, excellent JSON support [Source: architecture/3-tech-stack.md]
- **Supabase CLI 1.x** - Infrastructure as Code tool for database migrations and RLS policies [Source: architecture/3-tech-stack.md]
- **pgTAP 1.2+** - Database testing framework for testing RLS policies and migrations [Source: architecture/3-tech-stack.md]
- **PostgREST 2.x** - Supabase auto-generates RESTful endpoints from schema [Source: architecture/3-tech-stack.md]

### Backend Architecture Principles
Supabase provides a complete Backend-as-a-Service solution:

**Key Architectural Patterns:**
- **Zero Backend Code** - Supabase automatically generates REST API from PostgreSQL schema [Source: architecture/11-backend-architecture.md]
- **Row Level Security (RLS)** - Security enforced at database level, not application level [Source: architecture/11-backend-architecture.md]
- **Security Architecture:**
  - All tables MUST have Row Level Security (RLS) enabled
  - `auth.uid()` ensures user context in all queries
  - No application-level security logic needed
  - SECURITY DEFINER functions used for controlled privilege elevation (future stories)
  [Source: architecture/11-backend-architecture.md]

**Database Functions Pattern** (for future reference):
- Complex business logic in PostgreSQL functions
- Atomic operations (e.g., add_goal_with_assists)
- Bulk operations (e.g., bulk_update_attendance)
- Template-based generation (e.g., generate_training_sessions)
[Source: architecture/11-backend-architecture.md]

### Database Schema Overview
The `teams` table is the foundational table that will be referenced by many other tables in future stories.

**Teams Table Purpose:**
- Represents a coach's team profile
- Links to `auth.users` via `created_by` foreign key
- Used for data isolation via RLS policies
- First table in the schema, foundational for all other entities

**Schema Security Pattern:**
All tables follow this security pattern:
- RLS enabled on all tables [Source: architecture/9-database-schema.md]
- Policies ensure `coach_id = auth.uid()` or equivalent for complete data isolation [Source: architecture/9-database-schema.md]
- SECURITY DEFINER functions for elevated operations where needed [Source: architecture/9-database-schema.md]
- Comprehensive indexes on foreign keys and commonly filtered columns [Source: architecture/9-database-schema.md]

**Future Tables** (for context, not implemented in this story):
- `coaches` - User profiles extending auth.users
- `players` - Team roster with minimal PII
- `squads` - Player groupings
- `training_sessions` - Practice events
- `attendances` - Three-state attendance tracking
- `games` - Match records
- `goals`, `goal_assists`, `opponent_goals` - Scoring tracking
[Source: architecture/9-database-schema.md]

### Data Model: Teams Table
The `teams` table structure for this story:

**Schema Definition:**
```sql
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  season TEXT,
  logo_url TEXT,
  created_by UUID REFERENCES auth.users(id) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

**Column Details:**
- `id` - Unique identifier, auto-generated UUID
- `name` - Team name (required)
- `season` - Season identifier (e.g., "2024-2025")
- `logo_url` - URL to team logo in Supabase Storage (used in Story 1.5)
- `created_by` - Foreign key to auth.users, establishes ownership
- `created_at` - Timestamp of record creation
- `updated_at` - Timestamp of last update (auto-maintained by trigger)

**TypeScript Interface** (for future Angular integration):
```typescript
interface Team {
  id: string;
  name: string;
  season: string | null;
  logo_url: string | null;
  created_by: string;
  created_at: Date;
  updated_at: Date;
}
```

### Row Level Security (RLS) Implementation
RLS is critical for data isolation between users/coaches.

**RLS Policy Pattern:**
Every table must implement CRUD policies that enforce user ownership:

**For Teams Table:**
1. **SELECT Policy**: `auth.uid() = created_by`
   - Users can only query their own teams

2. **INSERT Policy**: `auth.uid() = created_by`
   - Users can only create teams with their own user_id

3. **UPDATE Policy**: `auth.uid() = created_by`
   - Users can only modify teams they own

4. **DELETE Policy**: `auth.uid() = created_by`
   - Users can only delete teams they own

**Security Requirements:**
- Database constraints validation at DB level [Source: architecture/15-security-and-performance.md]
- Supabase rate limiting (100 req/s) [Source: architecture/15-security-and-performance.md]
- RLS policies for complete data isolation [Source: architecture/15-security-and-performance.md]

### Development Workflow Context
**Supabase CLI Commands:**
```bash
# Initialize Supabase in project
supabase init

# Link to remote project
supabase link --project-ref <project-ref>

# Create new migration
supabase migration new <migration-name>

# Apply migrations to remote
supabase db push

# Generate TypeScript types (future use)
npm run supabase:types

# Run database tests
supabase test db
```
[Source: architecture/13-development-workflow.md]

**Local Development Setup** (for reference):
- Can use `supabase start` to run Supabase locally with Docker
- Migrations can be tested locally before pushing to remote
- For this story, we're setting up the remote project directly
[Source: architecture/13-development-workflow.md]

### Performance Considerations
**Backend Performance Requirements:**
- Response time < 200ms (p95) [Source: architecture/15-security-and-performance.md]
- Indexed foreign keys (add index on `created_by`) [Source: architecture/15-security-and-performance.md]
- Connection pooling (handled by Supabase) [Source: architecture/15-security-and-performance.md]
- Query optimization through proper indexing [Source: architecture/15-security-and-performance.md]

**Indexing Strategy for Teams Table:**
- Index on `created_by` is critical for RLS policy performance
- Primary key (`id`) automatically indexed

### File Locations
Based on project structure:
```
tsubasa/
├── supabase/
│   ├── config.toml              # Supabase configuration (created by supabase init)
│   ├── migrations/
│   │   └── YYYYMMDDHHMMSS_create_teams_table.sql  # Migration file
│   └── tests/
│       └── teams_test.sql       # pgTAP tests
├── .env                          # Environment variables (NOT committed)
└── .env.example                  # Example env file (committed)
```
[Source: architecture/12-unified-project-structure.md]

### Security Notes
**Critical Security Rules:**
- NEVER commit `.env` file to Git (should already be in `.gitignore` from Story 1.1)
- Database password is sensitive - store securely
- Supabase anon key is safe for client-side use (it's public)
- RLS policies are the security boundary, not application code
[Source: architecture/17-coding-standards.md]

## Dev Notes: Testing

### Testing Strategy for Database
This story introduces database testing using pgTAP, the standard PostgreSQL testing framework.

**Database Testing Framework:**
- **pgTAP 1.2+** - PostgreSQL testing framework for schema and RLS policy validation [Source: architecture/3-tech-stack.md]
- Tests run directly against the database
- Tests verify both schema structure and security policies

**Test Coverage Requirements:**
- All tables must have schema validation tests
- All RLS policies must have functional tests
- Minimum coverage thresholds apply (80% statements, 75% branches) [Source: architecture/16-testing-strategy.md]

**Key Test Areas for This Story:**
1. **Schema Validation:**
   - Table existence
   - Column types and constraints
   - Primary key and foreign key relationships
   - Default values and NOT NULL constraints

2. **RLS Policy Verification:**
   - User can only SELECT own records
   - User can only INSERT with their user_id
   - User cannot UPDATE other users' records
   - User cannot DELETE other users' records
   [Source: architecture/16-testing-strategy.md]

**pgTAP Test File Structure:**
```sql
-- /supabase/tests/teams_test.sql
BEGIN;
SELECT plan(20); -- Number of tests

-- Schema tests
SELECT has_table('teams');
SELECT has_column('teams', 'id');
-- ... more tests

-- RLS policy tests
SELECT policies_are('teams', ARRAY['select_policy_name', ...]);
-- ... more tests

SELECT * FROM finish();
ROLLBACK;
```

**Running Database Tests:**
```bash
# Run all database tests
supabase test db

# Run specific test file
supabase test db teams_test.sql
```

**Test File Locations:**
- Database tests: `/supabase/tests/*.sql`
[Source: architecture/12-unified-project-structure.md]

**Testing Pyramid Context:**
This story focuses on the database layer (integration tests):
- E2E Tests: 10%
- Integration Tests: 30% ← Database tests fall here
- Unit Tests: 60%
[Source: architecture/16-testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
