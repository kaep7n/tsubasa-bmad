# Story 1.4: Authentication Implementation (Supabase Auth)

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** user,
**I want** to sign up and log in with email/password or Google OAuth,
**so that** my team data is secure and isolated

## Acceptance Criteria
1. ✅ `AuthService` created with methods:
   - `signUp(email, password)` - Creates user account via Supabase Auth
   - `signIn(email, password)` - Authenticates user, returns JWT
   - `signInWithGoogle()` - OAuth flow via Supabase Auth Google provider
   - `signOut()` - Clears session and redirects to login
   - `getCurrentUser()` - Returns observable of current user state
2. ✅ `LoginComponent` created with:
   - Email/password form with validation (email format, password min length 8 chars)
   - "Sign in with Google" button
   - "Create account" link to registration form
   - Error handling for invalid credentials
3. ✅ `SignupComponent` created with:
   - Email/password/confirm password form with validation
   - Password strength indicator
   - "Already have an account?" link to login
4. ✅ Auth state persisted to localStorage (Supabase default behavior)
5. ✅ Route guards implemented:
   - `AuthGuard` - Redirects unauthenticated users to login
   - `UnauthGuard` - Redirects authenticated users away from login/signup
6. ✅ JWT token automatically included in Supabase client requests
7. ✅ Token refresh handled automatically by Supabase client (7-day expiry)
8. ✅ Unit tests for AuthService with mocked Supabase client
9. ✅ E2E test for login flow (Playwright)

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure Supabase Client** (AC: 1, 6, 7)
  - [ ] Install Supabase client: `npm install @supabase/supabase-js`
  - [ ] Create `/src/app/core/services/supabase.service.ts`
  - [ ] Initialize Supabase client with URL and anon key from environment
  - [ ] Export singleton Supabase client instance
  - [ ] Configure auto-refresh for JWT tokens (default 7-day expiry)

- [ ] **Task 2: Create AuthService** (AC: 1)
  - [ ] Create `/src/app/core/services/auth.service.ts`
  - [ ] Implement `signUp(email: string, password: string)` method using Supabase Auth
  - [ ] Implement `signIn(email: string, password: string)` method with JWT return
  - [ ] Implement `signInWithGoogle()` for OAuth flow via Supabase
  - [ ] Implement `signOut()` method that clears session and redirects to /login
  - [ ] Implement `getCurrentUser()` returning Observable<User | null> using Supabase auth state
  - [ ] Handle authentication errors (invalid credentials, network failures)
  - [ ] Add error handling with user-friendly messages

- [ ] **Task 3: Create LoginComponent** (AC: 2)
  - [ ] Generate component: `ng generate component features/auth/login`
  - [ ] Create reactive form with email and password fields
  - [ ] Add form validation:
    - Email: required, valid email format
    - Password: required, min length 8 characters
  - [ ] Add "Sign in with Google" button with OAuth handler
  - [ ] Add "Create account" link routing to /signup
  - [ ] Implement form submission calling AuthService.signIn()
  - [ ] Display error messages for invalid credentials
  - [ ] Add loading state during authentication
  - [ ] Redirect to dashboard on successful login
  - [ ] Style with Angular Material and Tailwind CSS

- [ ] **Task 4: Create SignupComponent** (AC: 3)
  - [ ] Generate component: `ng generate component features/auth/signup`
  - [ ] Create reactive form with email, password, and confirm password fields
  - [ ] Add form validation:
    - Email: required, valid email format
    - Password: required, min length 8 characters
    - Confirm password: required, must match password
  - [ ] Add password strength indicator (weak/medium/strong)
  - [ ] Add "Already have an account?" link routing to /login
  - [ ] Implement form submission calling AuthService.signUp()
  - [ ] Display error messages for validation failures
  - [ ] Show success message and auto-redirect to login after signup
  - [ ] Style with Angular Material and Tailwind CSS

- [ ] **Task 5: Implement Auth Route Guards** (AC: 5)
  - [ ] Create `/src/app/core/guards/auth.guard.ts` (functional guard)
  - [ ] AuthGuard: Check if user is authenticated, redirect to /login if not
  - [ ] Create `/src/app/core/guards/unauth.guard.ts` (functional guard)
  - [ ] UnauthGuard: Check if user is authenticated, redirect to /dashboard if yes
  - [ ] Apply AuthGuard to protected routes (dashboard, players, games, etc.)
  - [ ] Apply UnauthGuard to /login and /signup routes

- [ ] **Task 6: Configure Auth Routing** (AC: 2, 3, 5)
  - [ ] Update `/src/app/app.routes.ts` with auth routes:
    - `/login` - LoginComponent with UnauthGuard
    - `/signup` - SignupComponent with UnauthGuard
    - `/` - Redirect to /login or /dashboard based on auth state
  - [ ] Configure lazy loading for auth feature module
  - [ ] Set up default route redirects

- [ ] **Task 7: Configure Supabase Google OAuth** (AC: 1)
  - [ ] Go to Supabase dashboard > Authentication > Providers
  - [ ] Enable Google provider
  - [ ] Create Google OAuth 2.0 credentials at https://console.cloud.google.com
  - [ ] Configure OAuth consent screen
  - [ ] Add authorized redirect URIs: Supabase callback URL
  - [ ] Copy Client ID and Client Secret to Supabase
  - [ ] Test Google sign-in flow in browser

- [ ] **Task 8: Verify Auth State Persistence** (AC: 4)
  - [ ] Login with test account
  - [ ] Verify session token stored in localStorage (Supabase default)
  - [ ] Refresh page and confirm user remains authenticated
  - [ ] Verify JWT token persists across page refreshes
  - [ ] Test logout clears localStorage session

- [ ] **Task 9: Create Unit Tests for AuthService** (AC: 8)
  - [ ] Create `/src/app/core/services/auth.service.spec.ts`
  - [ ] Mock Supabase client using Jasmine spies
  - [ ] Test `signUp()` success and error scenarios
  - [ ] Test `signIn()` success and error scenarios
  - [ ] Test `signInWithGoogle()` OAuth flow
  - [ ] Test `signOut()` clears session correctly
  - [ ] Test `getCurrentUser()` returns correct user state
  - [ ] Verify test coverage meets 80% threshold

- [ ] **Task 10: Create E2E Test for Login Flow** (AC: 9)
  - [ ] Install Playwright: `npm install --save-dev @playwright/test`
  - [ ] Create `/tests/auth.spec.ts`
  - [ ] Test: User can navigate to login page
  - [ ] Test: User can sign up with email/password
  - [ ] Test: User can log in with valid credentials
  - [ ] Test: User sees error with invalid credentials
  - [ ] Test: Authenticated user redirected to dashboard
  - [ ] Test: User can log out successfully
  - [ ] Run E2E tests: `npx playwright test`

## Dev Notes

### Previous Story Context
**Dependencies:** This story requires Stories 1.1, 1.2, and 1.3 to be completed:
- Story 1.1: Angular project scaffolded with routing and testing setup
- Story 1.2: Supabase project configured with authentication enabled
- Story 1.3: CI/CD pipeline for running tests (including E2E with Playwright)

### Authentication Architecture
This story implements Supabase Auth for secure user authentication.

**Authentication Technology:**
- **Supabase Auth 2.x** - Integrated authentication with database RLS, JWT sessions, handles password reset [Source: architecture/3-tech-stack.md]
- **JWT Tokens** - JSON Web Tokens for stateless authentication
- **OAuth 2.0** - Google OAuth provider for social login

**Authentication Security:**
- 1-hour access tokens with automatic refresh
- Bcrypt password hashing (handled by Supabase)
- Email-based password reset flow
- JWT tokens in memory only (not in localStorage for security)
[Source: architecture/15-security-and-performance.md]

**API Authentication Headers:**
All Supabase API requests include:
```http
Authorization: Bearer {supabase-jwt-token}
apikey: {supabase-anon-key}
Content-Type: application/json
```
[Source: architecture/5-api-specification.md]

### Core Workflow: User Authentication & Team Setup
This story implements the first part of the core authentication workflow:

**Workflow Steps:**
1. User Authentication & Team Setup workflow includes:
   - Sign up with email/password or Google OAuth
   - Create team profile (Story 1.5)
   - Add players to roster (Epic 2)
[Source: architecture/8-core-workflows.md]

**Error Recovery Workflow:**
- Graceful handling of auth expiry
- Automatic token refresh
- Redirect to login on auth failure
[Source: architecture/8-core-workflows.md]

### Frontend Architecture: Auth Feature Module
Authentication follows the feature-based architecture pattern.

**File Structure:**
```
src/app/
├── core/
│   ├── services/
│   │   ├── supabase.service.ts        # Supabase client singleton
│   │   └── auth.service.ts             # Authentication service
│   ├── guards/
│   │   ├── auth.guard.ts               # Protect authenticated routes
│   │   └── unauth.guard.ts             # Protect login/signup routes
│   └── models/
│       └── user.model.ts               # User type definition
├── features/
│   └── auth/
│       ├── login/
│       │   ├── login.component.ts
│       │   ├── login.component.html
│       │   ├── login.component.scss
│       │   └── login.component.spec.ts
│       └── signup/
│           ├── signup.component.ts
│           ├── signup.component.html
│           ├── signup.component.scss
│           └── signup.component.spec.ts
└── app.routes.ts                       # Route configuration with guards
```
[Source: architecture/10-frontend-architecture.md]

**State Management for Auth:**
- Use RxJS BehaviorSubject in AuthService for current user state
- Components subscribe to Observable<User | null> from getCurrentUser()
- Service-based state management (no NgRx needed)
[Source: architecture/10-frontend-architecture.md]

### Supabase Client Configuration
**SupabaseService Implementation:**
```typescript
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class SupabaseService {
  private supabase: SupabaseClient;

  constructor() {
    this.supabase = createClient(
      environment.supabaseUrl,
      environment.supabaseAnonKey,
      {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true
        }
      }
    );
  }

  get client() {
    return this.supabase;
  }
}
```

**Environment Configuration:**
Add to `/src/environments/environment.ts`:
```typescript
export const environment = {
  production: false,
  supabaseUrl: 'https://<project-ref>.supabase.co',
  supabaseAnonKey: '<your-anon-key>'
};
```

### AuthService Interface
**Service Methods:**
```typescript
interface AuthService {
  signUp(email: string, password: string): Promise<AuthResponse>;
  signIn(email: string, password: string): Promise<AuthResponse>;
  signInWithGoogle(): Promise<AuthResponse>;
  signOut(): Promise<void>;
  getCurrentUser(): Observable<User | null>;
}
```

**User Model:**
```typescript
// /src/app/core/models/user.model.ts
export interface User {
  id: string;
  email: string;
  created_at: Date;
  // Additional fields from auth.users
}
```
[Source: architecture/4-data-models.md - User (Coach) section]

### Route Guards Implementation
**Functional Guards (Angular 17+):**
```typescript
// auth.guard.ts
export const authGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);

  return authService.getCurrentUser().pipe(
    map(user => {
      if (user) return true;
      router.navigate(['/login']);
      return false;
    })
  );
};

// unauth.guard.ts
export const unauthGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);

  return authService.getCurrentUser().pipe(
    map(user => {
      if (!user) return true;
      router.navigate(['/dashboard']);
      return false;
    })
  );
};
```
[Source: architecture/10-frontend-architecture.md - Routing Architecture]

### Form Validation Rules
**LoginComponent Validation:**
- Email: required, email format validator
- Password: required, minLength(8)

**SignupComponent Validation:**
- Email: required, email format validator
- Password: required, minLength(8), password strength validator
- Confirm Password: required, must match password (custom validator)

**Password Strength Indicator:**
- Weak: < 8 characters or no special characters
- Medium: 8+ characters with letters and numbers
- Strong: 8+ characters with letters, numbers, and special characters

### Coding Standards for Auth Implementation
**Critical Rules to Follow:**
- **Type Sharing:** Define User model in `core/models/user.model.ts`, never duplicate [Source: architecture/17-coding-standards.md]
- **API Calls:** Always use AuthService, never direct Supabase client calls from components [Source: architecture/17-coding-standards.md]
- **State Updates:** Use RxJS BehaviorSubject for user state [Source: architecture/17-coding-standards.md]
- **Auth Checks:** Rely on RLS policies in database, route guards in frontend [Source: architecture/17-coding-standards.md]

**Naming Conventions:**
- Components: PascalCase (LoginComponent, SignupComponent)
- Services: PascalCase + "Service" (AuthService, SupabaseService)
- Guards: camelCase + "Guard" (authGuard, unauthGuard)
[Source: architecture/17-coding-standards.md]

### Security Considerations
**Frontend Security Implementation:**
- **CSP Headers:** Configured via Cloudflare Pages (Story 1.3) [Source: architecture/15-security-and-performance.md]
- **XSS Protection:** Angular's built-in sanitization [Source: architecture/15-security-and-performance.md]
- **JWT Storage:** Tokens in memory only, avoid localStorage for tokens [Source: architecture/15-security-and-performance.md]

**Password Security:**
- Minimum 8 characters enforced
- Bcrypt hashing handled by Supabase Auth
- Password strength indicator guides users
[Source: architecture/15-security-and-performance.md]

**OAuth Security:**
- Google OAuth flow uses PKCE (Proof Key for Code Exchange)
- Redirect URIs whitelisted in Supabase dashboard
- State parameter prevents CSRF attacks

### Google OAuth Configuration Steps
1. Go to https://console.cloud.google.com
2. Create new project or select existing
3. Enable Google+ API
4. Configure OAuth consent screen:
   - App name: "Tsubasa"
   - User support email
   - Authorized domains: supabase.co
5. Create OAuth 2.0 credentials:
   - Application type: Web application
   - Authorized redirect URIs: `https://<project-ref>.supabase.co/auth/v1/callback`
6. Copy Client ID and Client Secret
7. Paste into Supabase dashboard > Authentication > Providers > Google

## Dev Notes: Testing

### Testing Strategy for Authentication
Authentication requires comprehensive testing across unit, integration, and E2E levels.

**Testing Frameworks:**
- **Jasmine 6.4 + Karma 6.2** - Unit tests for AuthService [Source: architecture/3-tech-stack.md]
- **Playwright 1.40+** - E2E tests for login flows [Source: architecture/3-tech-stack.md]

**Test Coverage Requirements:**
- AuthService must meet 80% statement coverage
- All public methods must have unit tests
- Critical paths must have E2E tests
[Source: architecture/16-testing-strategy.md]

### Unit Testing: AuthService
**Test File:** `/src/app/core/services/auth.service.spec.ts`

**Test Cases:**
1. `signUp()` - success scenario with valid email/password
2. `signUp()` - error scenario with duplicate email
3. `signIn()` - success scenario with valid credentials
4. `signIn()` - error scenario with invalid credentials
5. `signInWithGoogle()` - OAuth flow initiated correctly
6. `signOut()` - clears session and navigates to login
7. `getCurrentUser()` - returns null when not authenticated
8. `getCurrentUser()` - returns user when authenticated

**Mocking Supabase Client:**
```typescript
let mockSupabaseClient: jasmine.SpyObj<SupabaseClient>;

beforeEach(() => {
  mockSupabaseClient = jasmine.createSpyObj('SupabaseClient', {
    auth: jasmine.createSpyObj('Auth', ['signUp', 'signInWithPassword', 'signInWithOAuth', 'signOut', 'onAuthStateChange'])
  });

  TestBed.configureTestingModule({
    providers: [
      AuthService,
      { provide: SupabaseService, useValue: { client: mockSupabaseClient } }
    ]
  });
});
```

### E2E Testing: Login Flow
**Test File:** `/tests/auth.spec.ts`

**Test Cases:**
1. Navigation: User can visit /login page
2. Signup: User can create account with email/password
3. Login Success: User can log in with valid credentials and reaches dashboard
4. Login Failure: User sees error message with invalid credentials
5. Protected Route: Unauthenticated user redirected to /login
6. Authenticated Route: Authenticated user redirected from /login to /dashboard
7. Logout: User can log out and returns to /login

**Playwright Configuration:**
```typescript
// playwright.config.ts
export default defineConfig({
  testDir: './tests',
  use: {
    baseURL: 'http://localhost:4200',
    trace: 'on-first-retry',
  },
  webServer: {
    command: 'npm start',
    port: 4200,
  },
});
```

**Sample E2E Test:**
```typescript
test('user can log in with valid credentials', async ({ page }) => {
  await page.goto('/login');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL('/dashboard');
});
```

**Running E2E Tests:**
```bash
# Install browsers
npx playwright install

# Run tests
npx playwright test

# Run tests with UI
npx playwright test --ui
```

**Test File Locations:**
- Unit tests: Co-located with source files as `.spec.ts`
- E2E tests: `/tests/auth.spec.ts`
[Source: architecture/12-unified-project-structure.md]

**Testing Pyramid for This Story:**
- E2E Tests: Login flow (AC 9)
- Unit Tests: AuthService methods (AC 8)
[Source: architecture/16-testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
