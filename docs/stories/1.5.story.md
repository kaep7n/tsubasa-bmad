# Story 1.5: Team Creation & Profile Setup

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** new user,
**I want** to create my team profile after first login,
**so that** I can start adding players and tracking games

## Acceptance Criteria
1. ✅ `TeamSetupComponent` displayed after first login (if user has no team)
2. ✅ Form fields:
   - Team Name (required, text input)
   - Season (required, text input with placeholder "2024-2025")
   - Team Logo (optional, file upload - images only, max 2MB)
3. ✅ Logo upload uses Supabase Storage:
   - Bucket: `team-logos` with public read access
   - File naming: `{team_id}.{extension}`
   - Resize to 512x512px on client before upload (using canvas API)
4. ✅ On submit:
   - Create team record in `teams` table with `created_by = auth.uid()`
   - Upload logo to Supabase Storage (if provided)
   - Save logo URL to team record
   - Update user metadata: `app_metadata.team_id = team.id` (for RLS)
   - Redirect to dashboard
5. ✅ Error handling:
   - Network failures: Retry with exponential backoff
   - Validation errors: Inline error messages
   - Duplicate team name: Allow (not globally unique)
6. ✅ Loading state: Disable form during submission
7. ✅ Unit test: Verify team creation saves to Supabase
8. ✅ E2E test: Complete team setup flow after signup

## Tasks / Subtasks

- [ ] **Task 1: Create Supabase Storage Bucket** (AC: 3)
  - [ ] Go to Supabase dashboard > Storage
  - [ ] Create new bucket named `team-logos`
  - [ ] Set bucket to public read access
  - [ ] Configure bucket policies for authenticated uploads
  - [ ] Test bucket accessibility from browser

- [ ] **Task 2: Create TeamService** (AC: 4)
  - [ ] Create `/src/app/core/services/team.service.ts`
  - [ ] Implement `createTeam(name: string, season: string)` method
  - [ ] Implement `uploadTeamLogo(teamId: string, file: File)` method
  - [ ] Implement `updateTeamLogo(teamId: string, logoUrl: string)` method
  - [ ] Implement `getUserTeam()` method to check if user has team
  - [ ] Use Supabase client for all database operations
  - [ ] Return Observables for async operations

- [ ] **Task 3: Create Image Resize Utility** (AC: 3)
  - [ ] Create `/src/app/shared/utils/image-resize.util.ts`
  - [ ] Implement `resizeImage(file: File, maxWidth: number, maxHeight: number)` function
  - [ ] Use Canvas API to resize image to 512x512px
  - [ ] Maintain aspect ratio and center crop if needed
  - [ ] Convert resized image back to File object
  - [ ] Return Promise<File> with resized image

- [ ] **Task 4: Create TeamSetupComponent** (AC: 1, 2)
  - [ ] Generate component: `ng generate component features/team/team-setup`
  - [ ] Create reactive form with fields:
    - teamName (required, text)
    - season (required, text, placeholder "2024-2025")
    - teamLogo (optional, file input, images only, max 2MB)
  - [ ] Add form validation:
    - Team Name: required, min 2 characters, max 100 characters
    - Season: required, pattern for season format (e.g., "YYYY-YYYY")
    - Team Logo: optional, file type validation (image/*), max size 2MB
  - [ ] Add file input with preview
  - [ ] Display selected image preview before upload
  - [ ] Style with Angular Material and Tailwind CSS

- [ ] **Task 5: Implement Team Creation Logic** (AC: 4)
  - [ ] On form submit, call TeamService.createTeam()
  - [ ] If logo selected, resize image using image-resize utility
  - [ ] Upload resized logo to Supabase Storage bucket `team-logos`
  - [ ] Name file as `{team_id}.{extension}`
  - [ ] Get public URL of uploaded logo
  - [ ] Update team record with logo_url
  - [ ] Update user metadata with team_id (for RLS context)
  - [ ] Redirect to /dashboard on success

- [ ] **Task 6: Implement Error Handling** (AC: 5, 6)
  - [ ] Add loading state signal: `isLoading = signal(false)`
  - [ ] Disable form during submission (bind to isLoading)
  - [ ] Handle network failures with exponential backoff retry (3 attempts)
  - [ ] Display inline validation errors for form fields
  - [ ] Display error toast/snackbar for submission errors
  - [ ] Allow duplicate team names (no uniqueness constraint)
  - [ ] Log errors to console for debugging

- [ ] **Task 7: Implement First-Login Check** (AC: 1)
  - [ ] Update AuthService to check if user has team after login
  - [ ] If user has no team, redirect to /team-setup
  - [ ] If user has team, redirect to /dashboard
  - [ ] Add route configuration for /team-setup
  - [ ] Apply AuthGuard to /team-setup route

- [ ] **Task 8: Create Unit Tests for TeamService** (AC: 7)
  - [ ] Create `/src/app/core/services/team.service.spec.ts`
  - [ ] Mock Supabase client
  - [ ] Test `createTeam()` success scenario
  - [ ] Test `createTeam()` error scenario
  - [ ] Test `uploadTeamLogo()` success scenario
  - [ ] Test `getUserTeam()` returns team if exists
  - [ ] Test `getUserTeam()` returns null if no team
  - [ ] Verify 80% test coverage

- [ ] **Task 9: Create E2E Test for Team Setup** (AC: 8)
  - [ ] Add test to `/tests/team-setup.spec.ts`
  - [ ] Test: New user signs up successfully
  - [ ] Test: User redirected to team setup after signup
  - [ ] Test: User fills in team name and season
  - [ ] Test: User uploads team logo (optional)
  - [ ] Test: User submits form and redirected to dashboard
  - [ ] Test: Team data saved correctly in Supabase
  - [ ] Run E2E test: `npx playwright test team-setup.spec.ts`

## Dev Notes

### Previous Story Context
**Dependencies:** This story requires Stories 1.1, 1.2, and 1.4 to be completed:
- Story 1.1: Angular project with reactive forms and file handling
- Story 1.2: Supabase project with `teams` table and RLS policies
- Story 1.4: Authentication with user context (auth.uid())

**Teams Table Schema (from Story 1.2):**
The `teams` table was created in Story 1.2 with this structure:
```sql
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  season TEXT,
  logo_url TEXT,
  created_by UUID REFERENCES auth.users(id) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```
RLS policies ensure users can only create and manage their own teams.

### File Storage Architecture
This story implements Supabase Storage for team logo uploads.

**Storage Technology:**
- **Supabase Storage 2.x** - S3-compatible file storage, integrated with database authentication [Source: architecture/3-tech-stack.md]
- **Canvas API** - Browser API for client-side image resizing
- **File API** - Browser API for file handling

**Storage Bucket Configuration:**
- **Bucket Name:** `team-logos`
- **Access:** Public read, authenticated write
- **File Naming:** `{team_id}.{extension}` (e.g., "550e8400-e29b-41d4-a716-446655440000.png")
- **Max File Size:** 2MB
- **Allowed Types:** image/* (jpg, png, gif, webp)

**Storage RLS Policies:**
```sql
-- Allow authenticated users to upload
CREATE POLICY "Authenticated users can upload team logos"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'team-logos');

-- Allow public read access
CREATE POLICY "Public can view team logos"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'team-logos');

-- Allow users to update their own team logos
CREATE POLICY "Users can update own team logos"
ON storage.objects FOR UPDATE
TO authenticated
USING (bucket_id = 'team-logos' AND auth.uid() = owner);
```

### Data Model: Team Record
**TypeScript Interface:**
```typescript
// /src/app/core/models/team.model.ts
export interface Team {
  id: string;
  name: string;
  season: string | null;
  logo_url: string | null;
  created_by: string;
  created_at: Date;
  updated_at: Date;
}

export interface CreateTeamRequest {
  name: string;
  season: string;
  created_by: string; // auth.uid()
}
```

**Team Model from Architecture:**
- The User (Coach) has a 1:1 relationship with Team in v1
- `team_name` is stored with the coach profile
- `coach_id` is used for RLS policies on related tables
[Source: architecture/4-data-models.md]

### TeamService Implementation
**Service Interface:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class TeamService {
  constructor(private supabase: SupabaseService) {}

  createTeam(name: string, season: string): Observable<Team> {
    // Create team record in database
  }

  uploadTeamLogo(teamId: string, file: File): Observable<string> {
    // Upload to Supabase Storage, return public URL
  }

  updateTeamLogo(teamId: string, logoUrl: string): Observable<void> {
    // Update team record with logo URL
  }

  getUserTeam(): Observable<Team | null> {
    // Query teams table where created_by = auth.uid()
  }
}
```

### Image Resizing Utility
**Canvas API Implementation:**
```typescript
export async function resizeImage(
  file: File,
  maxWidth: number,
  maxHeight: number
): Promise<File> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Calculate dimensions (maintain aspect ratio, center crop)
      const size = Math.min(img.width, img.height);
      const left = (img.width - size) / 2;
      const top = (img.height - size) / 2;

      canvas.width = maxWidth;
      canvas.height = maxHeight;

      ctx?.drawImage(img, left, top, size, size, 0, 0, maxWidth, maxHeight);

      canvas.toBlob((blob) => {
        if (blob) {
          const resizedFile = new File([blob], file.name, { type: file.type });
          resolve(resizedFile);
        } else {
          reject(new Error('Failed to resize image'));
        }
      }, file.type);
    };

    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}
```

### Form Validation Rules
**TeamSetupComponent Validation:**
- **Team Name:**
  - Required
  - Min length: 2 characters
  - Max length: 100 characters

- **Season:**
  - Required
  - Pattern: YYYY-YYYY format (e.g., "2024-2025")
  - Placeholder: "2024-2025"

- **Team Logo:**
  - Optional
  - File type: image/* only (jpg, png, gif, webp)
  - Max size: 2MB (2,097,152 bytes)
  - Client-side resize to 512x512px before upload

### Error Handling Strategy
**Network Failure Retry:**
Implement exponential backoff for network failures:
```typescript
function retryWithBackoff<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> {
  return new Promise((resolve, reject) => {
    let retries = 0;
    const attempt = () => {
      operation()
        .then(resolve)
        .catch((error) => {
          if (retries < maxRetries) {
            retries++;
            const delay = Math.pow(2, retries) * 1000; // 2s, 4s, 8s
            setTimeout(attempt, delay);
          } else {
            reject(error);
          }
        });
    };
    attempt();
  });
}
```

**Error Types:**
1. **Validation Errors:** Display inline with form fields
2. **Network Failures:** Retry with exponential backoff, show toast if all retries fail
3. **Duplicate Team Name:** Allow (no constraint, show warning message)
4. **File Upload Errors:** Show error message, allow retry

### Frontend Architecture: Team Feature
**File Structure:**
```
src/app/
├── core/
│   ├── services/
│   │   └── team.service.ts              # Team CRUD operations
│   └── models/
│       └── team.model.ts                # Team TypeScript interface
├── features/
│   └── team/
│       └── team-setup/
│           ├── team-setup.component.ts
│           ├── team-setup.component.html
│           ├── team-setup.component.scss
│           └── team-setup.component.spec.ts
├── shared/
│   └── utils/
│       └── image-resize.util.ts         # Image resizing utility
└── app.routes.ts                        # Add /team-setup route
```
[Source: architecture/10-frontend-architecture.md]

### Routing Configuration
**App Routes Update:**
```typescript
// app.routes.ts
export const routes: Routes = [
  { path: 'login', component: LoginComponent, canActivate: [unauthGuard] },
  { path: 'signup', component: SignupComponent, canActivate: [unauthGuard] },
  { path: 'team-setup', component: TeamSetupComponent, canActivate: [authGuard] },
  { path: 'dashboard', component: DashboardComponent, canActivate: [authGuard] },
  { path: '', redirectTo: '/login', pathMatch: 'full' }
];
```

**Post-Login Navigation Logic:**
```typescript
// In AuthService after successful login
async onLoginSuccess() {
  const team = await this.teamService.getUserTeam().toPromise();
  if (!team) {
    this.router.navigate(['/team-setup']);
  } else {
    this.router.navigate(['/dashboard']);
  }
}
```

### Coding Standards
**Critical Rules:**
- **Type Sharing:** Define Team model in `core/models/team.model.ts` [Source: architecture/17-coding-standards.md]
- **API Calls:** Use TeamService, never direct Supabase calls from components [Source: architecture/17-coding-standards.md]
- **State Updates:** Use Signals for loading state [Source: architecture/17-coding-standards.md]

**Naming Conventions:**
- Service: TeamService (PascalCase + "Service")
- Model: Team (PascalCase)
- Component: TeamSetupComponent (PascalCase)
- Utility: resizeImage (camelCase)
[Source: architecture/17-coding-standards.md]

### Security Considerations
**Frontend Security:**
- Validate file types and sizes on client before upload
- Validate again on server (Supabase Storage handles this)
- Sanitize team name input (Angular handles this automatically)
[Source: architecture/15-security-and-performance.md]

**Database Security:**
- RLS policies ensure users can only create teams with their own user_id
- `created_by` field automatically set to auth.uid() in database
- No user can access another user's team data
[Source: architecture/15-security-and-performance.md]

**Storage Security:**
- Authenticated uploads only (RLS policy)
- Public read access for logos (needed for display)
- File naming prevents collisions (UUID-based)

### Performance Considerations
**Image Optimization:**
- Resize to 512x512px on client (reduces upload size)
- Use Canvas API for efficient client-side processing
- Compress image during resize (canvas.toBlob with quality parameter)

**Upload Performance:**
- Max 2MB upload size limit
- Supabase Storage uses CDN for fast delivery
- Public bucket enables browser caching

**Frontend Performance:**
- Lazy load TeamSetupComponent (only after login)
- Use OnPush change detection for component
[Source: architecture/15-security-and-performance.md]

## Dev Notes: Testing

### Testing Strategy for Team Setup
**Testing Frameworks:**
- **Jasmine + Karma** - Unit tests for TeamService [Source: architecture/3-tech-stack.md]
- **Playwright** - E2E tests for complete team setup flow [Source: architecture/3-tech-stack.md]

### Unit Testing: TeamService
**Test File:** `/src/app/core/services/team.service.spec.ts`

**Test Cases:**
1. `createTeam()` - successfully creates team record
2. `createTeam()` - handles database errors
3. `uploadTeamLogo()` - successfully uploads to Storage
4. `uploadTeamLogo()` - handles upload errors
5. `updateTeamLogo()` - updates team record with logo URL
6. `getUserTeam()` - returns team if user has one
7. `getUserTeam()` - returns null if user has no team
8. Image resize utility - correctly resizes to 512x512px

**Mocking Strategy:**
```typescript
let mockSupabase: jasmine.SpyObj<SupabaseService>;

beforeEach(() => {
  mockSupabase = jasmine.createSpyObj('SupabaseService', {
    client: {
      from: jasmine.createSpy('from').and.returnValue({
        insert: jasmine.createSpy('insert'),
        select: jasmine.createSpy('select'),
        update: jasmine.createSpy('update')
      }),
      storage: {
        from: jasmine.createSpy('from').and.returnValue({
          upload: jasmine.createSpy('upload'),
          getPublicUrl: jasmine.createSpy('getPublicUrl')
        })
      }
    }
  });
});
```

### E2E Testing: Team Setup Flow
**Test File:** `/tests/team-setup.spec.ts`

**Test Scenarios:**
1. New user completes signup and lands on team setup page
2. User fills in team name: "Warriors FC"
3. User fills in season: "2024-2025"
4. User uploads team logo (optional test)
5. User submits form
6. Loading state displayed during submission
7. User redirected to dashboard after success
8. Team record exists in Supabase with correct data

**Sample E2E Test:**
```typescript
test('new user can create team after signup', async ({ page }) => {
  // Sign up
  await page.goto('/signup');
  await page.fill('input[name="email"]', 'newuser@example.com');
  await page.fill('input[name="password"]', 'password123');
  await page.fill('input[name="confirmPassword"]', 'password123');
  await page.click('button[type="submit"]');

  // Should redirect to team setup
  await expect(page).toHaveURL('/team-setup');

  // Fill in team details
  await page.fill('input[name="teamName"]', 'Warriors FC');
  await page.fill('input[name="season"]', '2024-2025');

  // Submit form
  await page.click('button[type="submit"]');

  // Should redirect to dashboard
  await expect(page).toHaveURL('/dashboard');
});
```

**Test Coverage:**
- Cover both happy path (with logo) and without logo
- Test validation errors (empty fields, invalid file types)
- Test network error handling (mock network failure)
[Source: architecture/16-testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
