# Story 1.6: Dashboard Home Screen

## Status
Draft

## Story
**As a** coach,
**I want** to see upcoming games/training and recent results on the dashboard,
**so that** I have an overview of my team's schedule

## Acceptance Criteria
1. ✅ `DashboardComponent` created as default landing page after login
2. ✅ Dashboard displays:
   - **Header**: Team name and logo
   - **Upcoming Events** section:
     - Next 3 games (opponent, date/time, countdown "in 2 days")
     - Next 3 training sessions (date/time, location)
     - Empty state: "No upcoming events - tap + to create a game or training"
   - **Recent Results** section:
     - Last 5 games with result badges (W-D-L) and final score
     - Empty state: "No games played yet"
   - **Quick Actions** FAB menu:
     - Add Player
     - Create Game
     - Create Training Session
3. ✅ Data fetched from Supabase on component init:
   - Query `games` table filtered by `team_id`, ordered by date descending
   - Query `training_sessions` table filtered by `team_id`, ordered by date descending
4. ✅ Pull-to-refresh on mobile (Angular CDK Scrolling)
5. ✅ Loading state: Skeleton screens while data fetches
6. ✅ Offline mode: Display cached data from IndexedDB with sync status indicator
7. ✅ Navigation: Tapping event navigates to detail screen
8. ✅ Responsive: Two-column layout on tablet (768px+ width)
9. ✅ Unit test: Verify data fetching and display logic
10. ✅ E2E test: Navigate dashboard after team setup

## Tasks / Subtasks

- [ ] **Task 1: Create Database Tables for Games and Training** (AC: 3)
  - [ ] Create migration file: `supabase migration new add_games_training_tables`
  - [ ] Add `games` table schema:
    ```sql
    CREATE TABLE games (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      coach_id UUID REFERENCES auth.users(id) NOT NULL,
      date DATE NOT NULL,
      start_time TEXT,
      opponent TEXT NOT NULL,
      location TEXT,
      status TEXT CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled')),
      our_score INTEGER DEFAULT 0,
      opponent_score INTEGER DEFAULT 0,
      created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
      updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
    );
    ```
  - [ ] Add `training_sessions` table schema:
    ```sql
    CREATE TABLE training_sessions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      coach_id UUID REFERENCES auth.users(id) NOT NULL,
      date DATE NOT NULL,
      start_time TEXT NOT NULL,
      duration_minutes INTEGER,
      location TEXT,
      status TEXT CHECK (status IN ('scheduled', 'completed', 'cancelled')),
      created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
      updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
    );
    ```
  - [ ] Add RLS policies for both tables (coach_id = auth.uid())
  - [ ] Add indexes on coach_id and date columns
  - [ ] Apply migration: `supabase db push`

- [ ] **Task 2: Create Data Models** (AC: 2)
  - [ ] Create `/src/app/core/models/game.model.ts` with Game interface
  - [ ] Create `/src/app/core/models/training-session.model.ts` with TrainingSession interface
  - [ ] Define GameStatus type: 'scheduled' | 'in_progress' | 'completed' | 'cancelled'
  - [ ] Define TrainingStatus type: 'scheduled' | 'completed' | 'cancelled'

- [ ] **Task 3: Create GameService** (AC: 3)
  - [ ] Create `/src/app/core/services/game.service.ts`
  - [ ] Implement `getUpcomingGames(limit: number)` - query games where date >= today, order by date ASC
  - [ ] Implement `getRecentGames(limit: number)` - query games where status = 'completed', order by date DESC
  - [ ] Return Observables with RxJS
  - [ ] Filter by coach_id (handled by RLS)

- [ ] **Task 4: Create TrainingService** (AC: 3)
  - [ ] Create `/src/app/core/services/training.service.ts`
  - [ ] Implement `getUpcomingTrainingSessions(limit: number)` - query training where date >= today, order by date ASC
  - [ ] Return Observable with RxJS
  - [ ] Filter by coach_id (handled by RLS)

- [ ] **Task 5: Create DashboardComponent** (AC: 1, 2)
  - [ ] Generate component: `ng generate component features/dashboard`
  - [ ] Create component with three main sections:
    - Header with team name and logo
    - Upcoming Events section
    - Recent Results section
  - [ ] Add Floating Action Button (FAB) for Quick Actions menu
  - [ ] Use Angular Material Card for sections
  - [ ] Style with Tailwind CSS for responsive layout

- [ ] **Task 6: Implement Dashboard Data Fetching** (AC: 3)
  - [ ] In DashboardComponent ngOnInit:
    - Fetch team data (name, logo) from TeamService
    - Fetch upcoming games (next 3) from GameService
    - Fetch upcoming training sessions (next 3) from TrainingService
    - Fetch recent games (last 5) from GameService
  - [ ] Use combineLatest to fetch all data in parallel
  - [ ] Store data in component signals:
    - `team = signal<Team | null>(null)`
    - `upcomingGames = signal<Game[]>([])`
    - `upcomingTraining = signal<TrainingSession[]>([])`
    - `recentGames = signal<Game[]>([])`

- [ ] **Task 7: Implement Loading States** (AC: 5)
  - [ ] Add `isLoading = signal(true)` to component
  - [ ] Create skeleton screen components for:
    - Header skeleton
    - Event list skeleton (3 items)
    - Results list skeleton (5 items)
  - [ ] Display skeletons while isLoading = true
  - [ ] Set isLoading = false after data fetched

- [ ] **Task 8: Implement Empty States** (AC: 2)
  - [ ] For Upcoming Events: Display "No upcoming events - tap + to create a game or training" when empty
  - [ ] For Recent Results: Display "No games played yet" when empty
  - [ ] Style empty states with icon and helpful message
  - [ ] Add call-to-action button to create first event

- [ ] **Task 9: Implement Quick Actions FAB Menu** (AC: 2)
  - [ ] Add Angular Material FAB (mat-fab) button in bottom-right corner
  - [ ] On click, show speed dial menu with three options:
    - Add Player (navigate to /players/new)
    - Create Game (navigate to /games/new)
    - Create Training Session (navigate to /training/new)
  - [ ] Use mat-icon for icons (add, sports_soccer, fitness_center)
  - [ ] Animate menu open/close

- [ ] **Task 10: Implement Pull-to-Refresh** (AC: 4)
  - [ ] Install Angular CDK: Already installed with Material
  - [ ] Implement pull-to-refresh gesture for mobile
  - [ ] On pull-to-refresh, refetch all dashboard data
  - [ ] Show loading indicator during refresh
  - [ ] Display success message after refresh

- [ ] **Task 11: Implement Offline Mode Support** (AC: 6)
  - [ ] Note: Full offline foundation in Story 1.7
  - [ ] For this story, add sync status indicator:
    - Display "Online" badge when connected
    - Display "Offline - showing cached data" when disconnected
  - [ ] Listen to navigator.onLine for connectivity changes
  - [ ] Prepare for IndexedDB integration in Story 1.7

- [ ] **Task 12: Implement Event Navigation** (AC: 7)
  - [ ] Add click handlers to game cards:
    - Navigate to `/games/{id}` on click
  - [ ] Add click handlers to training cards:
    - Navigate to `/training/{id}` on click
  - [ ] Add hover/focus states for clickable cards

- [ ] **Task 13: Implement Responsive Layout** (AC: 8)
  - [ ] Mobile (<768px): Single column, stacked sections
  - [ ] Tablet (768px+): Two-column grid layout
    - Left column: Upcoming Events (60%)
    - Right column: Recent Results (40%)
  - [ ] Desktop (1024px+): Maintain two-column with max-width container
  - [ ] Use Tailwind CSS responsive utilities (sm:, md:, lg:)

- [ ] **Task 14: Create Unit Tests** (AC: 9)
  - [ ] Create `/src/app/features/dashboard/dashboard.component.spec.ts`
  - [ ] Mock GameService and TrainingService
  - [ ] Test component initialization fetches data
  - [ ] Test empty state displays when no data
  - [ ] Test loading state displays during fetch
  - [ ] Test game result badges (W-D-L) display correctly
  - [ ] Test navigation to detail screens
  - [ ] Verify 80% test coverage

- [ ] **Task 15: Create E2E Test** (AC: 10)
  - [ ] Add test to `/tests/dashboard.spec.ts`
  - [ ] Test: User completes team setup and lands on dashboard
  - [ ] Test: Dashboard displays team name and logo
  - [ ] Test: Empty states display when no games/training
  - [ ] Test: User can open Quick Actions FAB menu
  - [ ] Test: User can navigate to create game/training
  - [ ] Run E2E test: `npx playwright test dashboard.spec.ts`

## Dev Notes

### Previous Story Context
**Dependencies:** This story requires Stories 1.1-1.5 to be completed:
- Story 1.1: Angular project with Material and Tailwind
- Story 1.2: Supabase database with RLS policies
- Story 1.4: Authentication with user context
- Story 1.5: Team creation (dashboard displays team info)

**Note on Offline Support:**
Story 1.7 will implement the full offline foundation (Service Worker + IndexedDB). This story (1.6) prepares for offline support by:
- Adding sync status indicator
- Listening to connectivity changes
- Structuring data fetching for future caching

### Database Schema: Games and Training Tables
This story adds two new tables to support dashboard display.

**Games Table Schema:**
```sql
CREATE TABLE games (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  coach_id UUID REFERENCES auth.users(id) NOT NULL,
  date DATE NOT NULL,
  start_time TEXT,
  opponent TEXT NOT NULL,
  location TEXT,
  status TEXT CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled')),
  our_score INTEGER DEFAULT 0,
  opponent_score INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- RLS Policies
ALTER TABLE games ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own games" ON games
  FOR SELECT USING (auth.uid() = coach_id);

CREATE POLICY "Users can create games" ON games
  FOR INSERT WITH CHECK (auth.uid() = coach_id);

CREATE POLICY "Users can update own games" ON games
  FOR UPDATE USING (auth.uid() = coach_id);

CREATE POLICY "Users can delete own games" ON games
  FOR DELETE USING (auth.uid() = coach_id);

-- Indexes
CREATE INDEX idx_games_coach_id ON games(coach_id);
CREATE INDEX idx_games_date ON games(date);
CREATE INDEX idx_games_status ON games(status);
```

**Training Sessions Table Schema:**
```sql
CREATE TABLE training_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  coach_id UUID REFERENCES auth.users(id) NOT NULL,
  date DATE NOT NULL,
  start_time TEXT NOT NULL,
  duration_minutes INTEGER,
  location TEXT,
  status TEXT CHECK (status IN ('scheduled', 'completed', 'cancelled')),
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- RLS Policies
ALTER TABLE training_sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own training" ON training_sessions
  FOR SELECT USING (auth.uid() = coach_id);

CREATE POLICY "Users can create training" ON training_sessions
  FOR INSERT WITH CHECK (auth.uid() = coach_id);

CREATE POLICY "Users can update own training" ON training_sessions
  FOR UPDATE USING (auth.uid() = coach_id);

CREATE POLICY "Users can delete own training" ON training_sessions
  FOR DELETE USING (auth.uid() = coach_id);

-- Indexes
CREATE INDEX idx_training_coach_id ON training_sessions(coach_id);
CREATE INDEX idx_training_date ON training_sessions(date);
```

**Schema Security:**
- Both tables follow standard RLS pattern with coach_id
- Indexes on coach_id and date for query performance
- RLS policies ensure complete data isolation
[Source: architecture/9-database-schema.md]

### Data Models
**Game Model:**
```typescript
// /src/app/core/models/game.model.ts
export type GameStatus = 'scheduled' | 'in_progress' | 'completed' | 'cancelled';

export interface Game {
  id: string;
  coach_id: string;
  date: Date;
  start_time: string | null;
  opponent: string;
  location: string | null;
  status: GameStatus;
  our_score: number;
  opponent_score: number;
  created_at: Date;
  updated_at: Date;
}

export interface GameResultBadge {
  label: 'W' | 'D' | 'L';
  color: 'success' | 'warning' | 'error';
}
```
[Source: architecture/4-data-models.md - Game section]

**Training Session Model:**
```typescript
// /src/app/core/models/training-session.model.ts
export type TrainingStatus = 'scheduled' | 'completed' | 'cancelled';

export interface TrainingSession {
  id: string;
  coach_id: string;
  date: Date;
  start_time: string;
  duration_minutes: number | null;
  location: string | null;
  status: TrainingStatus;
  created_at: Date;
  updated_at: Date;
}
```
[Source: architecture/4-data-models.md - TrainingSession section]

### Service Layer Implementation
**GameService Interface:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class GameService {
  constructor(private supabase: SupabaseService) {}

  getUpcomingGames(limit: number = 3): Observable<Game[]> {
    // Query: WHERE date >= today AND status != 'completed'
    // ORDER BY date ASC LIMIT limit
  }

  getRecentGames(limit: number = 5): Observable<Game[]> {
    // Query: WHERE status = 'completed'
    // ORDER BY date DESC LIMIT limit
  }

  getGameById(id: string): Observable<Game> {
    // Query: WHERE id = id
  }

  // Additional methods for Epic 4 (Game Management)
}
```

**TrainingService Interface:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class TrainingService {
  constructor(private supabase: SupabaseService) {}

  getUpcomingTrainingSessions(limit: number = 3): Observable<TrainingSession[]> {
    // Query: WHERE date >= today AND status != 'cancelled'
    // ORDER BY date ASC LIMIT limit
  }

  getTrainingById(id: string): Observable<TrainingSession> {
    // Query: WHERE id = id
  }

  // Additional methods for Epic 3 (Training Sessions)
}
```

**API Calls Pattern:**
Always use service layer, never direct Supabase calls from components [Source: architecture/17-coding-standards.md]

### Frontend Architecture: Dashboard Feature
**File Structure:**
```
src/app/
├── core/
│   ├── services/
│   │   ├── game.service.ts
│   │   └── training.service.ts
│   └── models/
│       ├── game.model.ts
│       └── training-session.model.ts
├── features/
│   └── dashboard/
│       ├── dashboard.component.ts
│       ├── dashboard.component.html
│       ├── dashboard.component.scss
│       ├── dashboard.component.spec.ts
│       └── components/
│           ├── event-card/
│           ├── result-badge/
│           ├── empty-state/
│           └── loading-skeleton/
└── shared/
    └── components/
        └── fab-menu/
```
[Source: architecture/10-frontend-architecture.md]

### State Management: Dashboard
Use Signals for component state (Angular 17+):
```typescript
export class DashboardComponent {
  // State signals
  team = signal<Team | null>(null);
  upcomingGames = signal<Game[]>([]);
  upcomingTraining = signal<TrainingSession[]>([]);
  recentGames = signal<Game[]>([]);
  isLoading = signal(true);
  isOnline = signal(navigator.onLine);

  // Computed signals
  hasUpcomingEvents = computed(() =>
    this.upcomingGames().length > 0 || this.upcomingTraining().length > 0
  );

  hasRecentGames = computed(() =>
    this.recentGames().length > 0
  );
}
```
[Source: architecture/10-frontend-architecture.md - State Management]

### UI Components and Styling
**Angular Material Components Used:**
- `mat-card` - Section containers
- `mat-fab` - Floating Action Button for Quick Actions
- `mat-icon` - Icons throughout dashboard
- `mat-badge` - Result badges (W-D-L)
- `mat-progress-spinner` - Loading indicators
- `mat-menu` - FAB speed dial menu

**Tailwind CSS Responsive Layout:**
```html
<!-- Mobile: Single column -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <!-- Upcoming Events -->
  <mat-card class="md:col-span-1">...</mat-card>

  <!-- Recent Results -->
  <mat-card class="md:col-span-1">...</mat-card>
</div>
```

**Result Badge Logic:**
```typescript
function getResultBadge(game: Game): GameResultBadge {
  if (game.our_score > game.opponent_score) {
    return { label: 'W', color: 'success' }; // Green
  } else if (game.our_score < game.opponent_score) {
    return { label: 'L', color: 'error' }; // Red
  } else {
    return { label: 'D', color: 'warning' }; // Yellow
  }
}
```

### Countdown Display Implementation
Display relative time for upcoming events (e.g., "in 2 days"):
```typescript
function getCountdown(eventDate: Date): string {
  const now = new Date();
  const diff = eventDate.getTime() - now.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days === 0) return 'Today';
  if (days === 1) return 'Tomorrow';
  if (days > 1) return `in ${days} days`;
  return 'Past event';
}
```

Use libraries like `date-fns` or Angular's `DatePipe` for formatting.

### Pull-to-Refresh Implementation
Using Angular CDK for mobile pull-to-refresh:
```typescript
import { CdkScrollable } from '@angular/cdk/scrolling';

@Component({...})
export class DashboardComponent {
  @ViewChild(CdkScrollable) scrollable!: CdkScrollable;

  onRefresh() {
    this.isLoading.set(true);

    // Refetch all data
    combineLatest([
      this.gameService.getUpcomingGames(3),
      this.trainingService.getUpcomingTrainingSessions(3),
      this.gameService.getRecentGames(5)
    ]).pipe(
      finalize(() => this.isLoading.set(false))
    ).subscribe(([games, training, recent]) => {
      this.upcomingGames.set(games);
      this.upcomingTraining.set(training);
      this.recentGames.set(recent);
    });
  }
}
```

### Offline Support Preparation
**Sync Status Indicator:**
```typescript
// Listen to connectivity changes
fromEvent(window, 'online').subscribe(() => {
  this.isOnline.set(true);
  this.onRefresh(); // Sync when back online
});

fromEvent(window, 'offline').subscribe(() => {
  this.isOnline.set(false);
});
```

**Offline Mode Display:**
```html
<div class="sync-status" *ngIf="!isOnline()">
  <mat-icon>cloud_off</mat-icon>
  <span>Offline - showing cached data</span>
</div>
```

**Note:** Full offline support with IndexedDB and Service Worker will be implemented in Story 1.7 [Source: architecture/15-security-and-performance.md]

### Performance Optimization
**Frontend Performance:**
- Lazy load dashboard feature module [Source: architecture/15-security-and-performance.md]
- Use OnPush change detection for components
- Limit queries (3 upcoming, 5 recent) to reduce data transfer
- Cache dashboard data in memory (refresh on pull-to-refresh)

**Database Performance:**
- Indexes on coach_id and date for fast queries [Source: architecture/15-security-and-performance.md]
- Limit queries to reduce data transfer
- RLS policies use indexed columns for efficiency

### Coding Standards
**Critical Rules:**
- **Type Sharing:** Define Game and TrainingSession in core/models [Source: architecture/17-coding-standards.md]
- **API Calls:** Use GameService and TrainingService, never direct Supabase [Source: architecture/17-coding-standards.md]
- **State Updates:** Use Signals .set() and .update() [Source: architecture/17-coding-standards.md]

**Naming Conventions:**
- Components: DashboardComponent, EventCardComponent
- Services: GameService, TrainingService
- Models: Game, TrainingSession
- Database tables: games, training_sessions (snake_case)
[Source: architecture/17-coding-standards.md]

## Dev Notes: Testing

### Testing Strategy
**Testing Frameworks:**
- **Jasmine + Karma** - Unit tests for component and services [Source: architecture/3-tech-stack.md]
- **Playwright** - E2E test for dashboard navigation [Source: architecture/3-tech-stack.md]

**Test Coverage Requirements:**
- DashboardComponent: 80% statement coverage
- GameService and TrainingService: 80% coverage
- All empty states and loading states must be tested
[Source: architecture/16-testing-strategy.md]

### Unit Testing: DashboardComponent
**Test File:** `/src/app/features/dashboard/dashboard.component.spec.ts`

**Test Cases:**
1. Component initialization fetches team, games, and training data
2. Loading state displays skeleton screens during fetch
3. Empty state for upcoming events displays when no data
4. Empty state for recent games displays when no completed games
5. Game result badges (W-D-L) display correctly based on scores
6. Countdown displays correctly ("Today", "Tomorrow", "in 2 days")
7. Click on game card navigates to game detail page
8. Click on training card navigates to training detail page
9. FAB menu opens and displays three actions
10. Pull-to-refresh refetches all data
11. Offline indicator displays when navigator.onLine = false

**Mocking Strategy:**
```typescript
let mockGameService: jasmine.SpyObj<GameService>;
let mockTrainingService: jasmine.SpyObj<TrainingService>;
let mockTeamService: jasmine.SpyObj<TeamService>;

beforeEach(() => {
  mockGameService = jasmine.createSpyObj('GameService', [
    'getUpcomingGames',
    'getRecentGames'
  ]);

  mockTrainingService = jasmine.createSpyObj('TrainingService', [
    'getUpcomingTrainingSessions'
  ]);

  mockTeamService = jasmine.createSpyObj('TeamService', [
    'getUserTeam'
  ]);

  // Setup default return values
  mockGameService.getUpcomingGames.and.returnValue(of([]));
  mockGameService.getRecentGames.and.returnValue(of([]));
  mockTrainingService.getUpcomingTrainingSessions.and.returnValue(of([]));
  mockTeamService.getUserTeam.and.returnValue(of(mockTeam));

  TestBed.configureTestingModule({
    providers: [
      { provide: GameService, useValue: mockGameService },
      { provide: TrainingService, useValue: mockTrainingService },
      { provide: TeamService, useValue: mockTeamService }
    ]
  });
});
```

### E2E Testing: Dashboard Navigation
**Test File:** `/tests/dashboard.spec.ts`

**Test Scenarios:**
1. User completes team setup and lands on dashboard
2. Dashboard header displays team name and logo
3. Empty states display when no games or training sessions exist
4. FAB menu can be opened and closed
5. User can click "Create Game" and navigate to game creation form
6. Dashboard is responsive on mobile and tablet viewports

**Sample E2E Test:**
```typescript
test('dashboard displays empty state for new team', async ({ page }) => {
  // Login and complete team setup
  await completeTeamSetup(page);

  // Should be on dashboard
  await expect(page).toHaveURL('/dashboard');

  // Should display team name in header
  await expect(page.locator('h1')).toContainText('Warriors FC');

  // Should display empty states
  await expect(page.locator('text=No upcoming events')).toBeVisible();
  await expect(page.locator('text=No games played yet')).toBeVisible();

  // Should have FAB menu
  await expect(page.locator('button[mat-fab]')).toBeVisible();
});
```

**Responsive Testing:**
```typescript
test('dashboard layout is responsive', async ({ page }) => {
  await page.goto('/dashboard');

  // Mobile viewport (single column)
  await page.setViewportSize({ width: 375, height: 667 });
  // Assert single column layout

  // Tablet viewport (two columns)
  await page.setViewportSize({ width: 768, height: 1024 });
  // Assert two column layout
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
