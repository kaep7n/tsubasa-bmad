# Story 2.3: Add Player Form

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to add a new player to my roster,
**so that** I can track their performance

## Acceptance Criteria
1. ✅ `AddPlayerComponent` created with form fields:
   - First Name (required, text input)
   - Last Name (required, text input)
   - Date of Birth (optional, date picker)
   - Jersey Number (optional, number input 1-99)
   - Photo (optional, file upload - images only, max 5MB)
   - Squad (optional, dropdown: "Starters" | "Substitutes")
2. ✅ Form validation:
   - First/Last name: Required, min 2 chars, max 50 chars
   - Jersey number: Optional, integer 1-99, unique within team (show warning if duplicate)
   - Photo: Optional, image formats only (JPEG, PNG, HEIC), max 5MB
3. ✅ Photo upload flow:
   - Client-side resize to 512x512px using canvas API
   - Upload to Supabase Storage bucket: `player-photos`
   - File naming: `{team_id}/{player_id}.{extension}`
   - Set public read access on upload
4. ✅ On submit:
   - Generate UUID for player_id client-side
   - Upload photo (if provided), get public URL
   - Insert player record to Supabase `players` table
   - Save to IndexedDB (if offline, add to sync queue)
   - Navigate to player detail screen
   - Show toast: "Player added: {First Name} {Last Name}"
5. ✅ Offline handling:
   - Form submission works offline
   - Photo upload queued for sync
   - Record saved to IndexedDB with `sync_state = 'pending'`
6. ✅ Error handling:
   - Network failures: Retry with exponential backoff
   - Validation errors: Inline error messages
   - Storage quota exceeded: Show error, suggest deleting old photos
7. ✅ Loading state: Disable form during submission
8. ✅ Cancel button: Navigate back to player list (with confirmation if form dirty)
9. ✅ Unit test: Verify form validation and submission logic
10. ✅ E2E test: Add player with photo, verify saved to database

## Tasks / Subtasks

- [ ] **Task 1: Generate AddPlayerComponent** (AC: 1)
  - [ ] Run: `ng generate component features/players/pages/player-form`
  - [ ] Add route: `/players/new`
  - [ ] Create reactive form with FormBuilder

- [ ] **Task 2: Build Form with Validation** (AC: 1, 2)
  - [ ] Add form fields: firstName, lastName, dateOfBirth, jerseyNumber, photo, squad
  - [ ] Add validators: Validators.required, Validators.minLength(2), Validators.maxLength(50)
  - [ ] Custom validator for jersey number uniqueness
  - [ ] File input validator for image type and size

- [ ] **Task 3: Create Image Resize Utility** (AC: 3)
  - [ ] Create `/src/app/shared/utils/image-resize.util.ts`
  - [ ] Implement Canvas API resize to 512x512px
  - [ ] Maintain aspect ratio with center crop
  - [ ] Return resized File object

- [ ] **Task 4: Implement Photo Upload** (AC: 3)
  - [ ] Create Supabase Storage bucket `player-photos` (if not exists)
  - [ ] Upload resized photo: `supabase.storage.from('player-photos').upload()`
  - [ ] Generate public URL for photo
  - [ ] Handle upload errors

- [ ] **Task 5: Implement Form Submission** (AC: 4)
  - [ ] Generate UUID: `crypto.randomUUID()`
  - [ ] Upload photo first (if provided)
  - [ ] Insert player to Supabase with photo_url
  - [ ] Save to IndexedDB
  - [ ] Navigate to `/players/{id}`
  - [ ] Show success toast

- [ ] **Task 6: Offline Handling** (AC: 5)
  - [ ] Check network status before submit
  - [ ] If offline: Save to IndexedDB only
  - [ ] Add to sync queue with operation='INSERT'
  - [ ] Queue photo upload for later
  - [ ] Show "Saved offline" message

- [ ] **Task 7: Error Handling** (AC: 6, 7)
  - [ ] Try-catch for network errors
  - [ ] Exponential backoff retry (3 attempts)
  - [ ] Display validation errors inline
  - [ ] Handle storage quota errors
  - [ ] Disable form during submission (loading state)

- [ ] **Task 8: Cancel Button** (AC: 8)
  - [ ] Add cancel button in form footer
  - [ ] Check if form dirty: `form.dirty`
  - [ ] Show confirmation dialog if changes exist
  - [ ] Navigate back to /players

- [ ] **Task 9: Write Unit Tests** (AC: 9)
  - [ ] Test form validation rules
  - [ ] Test image resize utility
  - [ ] Test submission logic with mocks
  - [ ] Test offline mode behavior

- [ ] **Task 10: Write E2E Test** (AC: 10)
  - [ ] Navigate to /players/new
  - [ ] Fill form with test data
  - [ ] Upload test image
  - [ ] Submit form
  - [ ] Verify player appears in database and list

## Dev Notes

### Component Location
`/src/app/features/players/pages/player-form/player-form.component.ts`

This component will be reused for both Add (Story 2.3) and Edit (Story 2.4) by checking route params.

### Form Structure (Reactive Forms)
```typescript
playerForm = this.fb.group({
  firstName: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(50)]],
  lastName: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(50)]],
  dateOfBirth: [null],
  jerseyNumber: [null, [Validators.min(1), Validators.max(99)]],
  squad: [null],
  photo: [null]
});
```
[Source: architecture/10-frontend-architecture.md]

### Photo Upload to Supabase Storage
**Bucket:** `player-photos`
**Path structure:** `{team_id}/{player_id}.{ext}`
**Access:** Public read

```typescript
const { data, error } = await this.supabase.storage
  .from('player-photos')
  .upload(`${teamId}/${playerId}.jpg`, resizedFile, {
    cacheControl: '3600',
    upsert: false
  });
```
[Source: architecture/3-tech-stack.md: "Supabase Storage 2.x"]

### Offline-First Pattern
1. Always save to IndexedDB first (optimistic UI)
2. Add operation to sync queue
3. If online, sync immediately
4. If offline, queue for background sync
[Source: architecture/10-frontend-architecture.md]

### UUID Generation
Use browser's crypto API for UUID generation:
```typescript
const playerId = crypto.randomUUID();
```
Ensures client-generated IDs are unique and compatible with PostgreSQL UUID type.

## Dev Notes: Testing

### Unit Tests
**File:** `player-form.component.spec.ts`

Test coverage:
- Form initialization
- Validation errors display
- Image resize works correctly
- Submission with all fields
- Submission with minimal fields
- Offline submission queues sync
[Source: architecture/16-testing-strategy.md]

### E2E Test
**File:** `tests/e2e/player-management.spec.ts`

```typescript
test('should add player with photo', async ({ page }) => {
  await page.goto('/players/new');
  await page.fill('[name="firstName"]', 'John');
  await page.fill('[name="lastName"]', 'Doe');
  await page.fill('[name="jerseyNumber"]', '10');
  await page.setInputFiles('[type="file"]', 'test-photo.jpg');
  await page.click('button[type="submit"]');

  await expect(page).toHaveURL(/\/players\/.+/);
  await expect(page.locator('text=John Doe')).toBeVisible();
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation for Epic 2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
