# Story 2.4: Edit Player Form

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to edit player details,
**so that** I can correct mistakes or update information

## Acceptance Criteria
1. ✅ `EditPlayerComponent` created (reuses form from AddPlayerComponent)
2. ✅ Form pre-populated with existing player data on load
3. ✅ Photo handling:
   - Display current photo if exists
   - "Change Photo" button to upload new photo
   - "Remove Photo" button to delete photo (sets `photo_url = null`)
4. ✅ On submit:
   - Update player record in Supabase `players` table
   - Update IndexedDB (if offline, add to sync queue)
   - Set `updated_at = now()`
   - Navigate back to player detail screen
   - Show toast: "Player updated: {First Name} {Last Name}"
5. ✅ Photo replacement:
   - Upload new photo to Supabase Storage (overwrites old file)
   - Update `photo_url` in player record
6. ✅ Photo deletion:
   - Delete photo from Supabase Storage
   - Set `photo_url = null` in player record
7. ✅ Offline handling:
   - Form submission works offline
   - Photo operations queued for sync
   - Record updated in IndexedDB with `sync_state = 'pending'`
8. ✅ Conflict resolution:
   - If player was updated by another device, show warning
   - Offer options: "Keep my changes" | "Use server version" | "Merge manually"
9. ✅ Cancel button: Navigate back without saving (with confirmation if form dirty)
10. ✅ Unit test: Verify update logic and conflict resolution
11. ✅ E2E test: Edit player, verify changes saved

## Tasks / Subtasks

- [ ] **Task 1: Setup Edit Mode in PlayerFormComponent** (AC: 1, 2)
  - [ ] Detect edit mode from route params: `/players/:id/edit`
  - [ ] Load existing player data: `playerService.getPlayer(id)`
  - [ ] Pre-populate form with player data using `form.patchValue()`

- [ ] **Task 2: Implement Photo Display and Actions** (AC: 3)
  - [ ] Show current photo if `photo_url` exists
  - [ ] Add "Change Photo" button (file input trigger)
  - [ ] Add "Remove Photo" button (sets photo to null)
  - [ ] Preview new photo before upload

- [ ] **Task 3: Implement Update Submission** (AC: 4)
  - [ ] On submit: Call `playerService.updatePlayer(id, data)`
  - [ ] Update Supabase: `supabase.from('players').update().eq('id', id)`
  - [ ] Update IndexedDB with changes
  - [ ] Navigate to `/players/:id` (detail screen)
  - [ ] Show success toast

- [ ] **Task 4: Handle Photo Replacement** (AC: 5)
  - [ ] Upload new photo to same path (overwrites old)
  - [ ] Update `photo_url` field in player record
  - [ ] Delete old photo first if filename changes

- [ ] **Task 5: Handle Photo Deletion** (AC: 6)
  - [ ] Call `supabase.storage.from('player-photos').remove()`
  - [ ] Set `photo_url = null` in database
  - [ ] Clear photo preview in UI

- [ ] **Task 6: Offline Handling** (AC: 7)
  - [ ] Check network status before submission
  - [ ] If offline: Update IndexedDB only
  - [ ] Add UPDATE operation to sync queue
  - [ ] Queue photo operations for later sync

- [ ] **Task 7: Implement Conflict Resolution** (AC: 8)
  - [ ] Check `updated_at` timestamp before update
  - [ ] If server version newer: Show conflict dialog
  - [ ] Options: Keep my changes | Use server version | Merge
  - [ ] Implement last-write-wins by default

- [ ] **Task 8: Cancel Button** (AC: 9)
  - [ ] Add cancel button
  - [ ] Check if form dirty
  - [ ] Show confirmation if changes exist
  - [ ] Navigate back to player detail

- [ ] **Task 9: Write Unit Tests** (AC: 10)
  - [ ] Test form pre-population
  - [ ] Test update submission
  - [ ] Test conflict detection
  - [ ] Test photo operations

- [ ] **Task 10: Write E2E Test** (AC: 11)
  - [ ] Navigate to edit form
  - [ ] Change player data
  - [ ] Upload new photo
  - [ ] Submit and verify changes

## Dev Notes

### Component Reuse
The PlayerFormComponent is reused for both Add (Story 2.3) and Edit (Story 2.4):

```typescript
ngOnInit() {
  const id = this.route.snapshot.paramMap.get('id');
  if (id) {
    this.isEditMode = true;
    this.loadPlayer(id);
  }
}
```
[Source: architecture/10-frontend-architecture.md: "Component reusability"]

### Conflict Resolution Strategy
Use `updated_at` timestamp to detect conflicts (last-write-wins):

```typescript
if (serverPlayer.updated_at > localPlayer.updated_at) {
  // Show conflict warning
  this.showConflictDialog(localPlayer, serverPlayer);
}
```
[Source: PRD Epic 2 Story 2.4 AC #8]

### Photo Replacement Logic
When uploading new photo:
1. Upload to same path (overwrites old file automatically)
2. If filename different, delete old file first
3. Update `photo_url` in player record

```typescript
// Overwrite existing photo
await this.supabase.storage
  .from('player-photos')
  .upload(`${teamId}/${playerId}.jpg`, newFile, { upsert: true });
```

### Offline Update Pattern
1. Update IndexedDB immediately (optimistic UI)
2. Add UPDATE operation to sync queue
3. Mark record as `sync_state = 'pending'`
4. When online, process sync queue
[Source: architecture/10-frontend-architecture.md]

## Dev Notes: Testing

### Unit Tests
**File:** `player-form.component.spec.ts`

Additional test cases for edit mode:
- Form pre-populates with player data
- Update submission works correctly
- Photo replacement logic
- Photo deletion logic
- Conflict detection works
[Source: architecture/16-testing-strategy.md]

### E2E Test
**File:** `tests/e2e/player-management.spec.ts`

```typescript
test('should edit player details', async ({ page }) => {
  await page.goto('/players/123/edit');
  await page.fill('[name="firstName"]', 'Jane');
  await page.click('button[type="submit"]');

  await expect(page).toHaveURL('/players/123');
  await expect(page.locator('text=Jane')).toBeVisible();
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation for Epic 2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
