# Story 2.5: Delete Player (Soft Delete)

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to delete players who leave the team,
**so that** my roster remains current

## Acceptance Criteria
1. ✅ "Delete Player" button on player detail screen
2. ✅ Tapping "Delete" shows confirmation dialog:
   - Title: "Delete {First Name} {Last Name}?"
   - Message: "This will remove the player from your roster. Their statistics will be preserved. This action can be undone within 90 days."
   - Actions: "Cancel" | "Delete"
3. ✅ On confirm:
   - Soft delete: Set `deleted_at = now()` in player record (do NOT hard delete)
   - Update IndexedDB (if offline, add to sync queue)
   - Navigate back to player list
   - Show toast with undo action: "Player deleted" [Undo]
4. ✅ Undo functionality:
   - If "Undo" tapped within 5 seconds, set `deleted_at = null`
   - Re-sync to Supabase
   - Show toast: "Deletion cancelled"
5. ✅ Soft-deleted players:
   - Excluded from player list queries (`WHERE deleted_at IS NULL`)
   - Statistics remain intact (goals, assists, attendance preserved)
   - Can be hard-deleted after 90 days (manual or automated cleanup job)
6. ✅ Offline handling:
   - Deletion works offline
   - Delete operation added to sync queue
7. ✅ Unit test: Verify soft delete and undo logic
8. ✅ E2E test: Delete player, undo, verify player restored

## Tasks / Subtasks

- [ ] **Task 1: Add Delete Button to Player Detail** (AC: 1)
  - [ ] Add delete button in player detail screen
  - [ ] Position in toolbar or as danger zone action
  - [ ] Style with Angular Material warn color

- [ ] **Task 2: Create Confirmation Dialog** (AC: 2)
  - [ ] Use Angular Material Dialog: `MatDialog.open()`
  - [ ] Create `ConfirmDeleteDialogComponent`
  - [ ] Display player name in title
  - [ ] Show preservation message
  - [ ] Return dialog result (confirmed: boolean)

- [ ] **Task 3: Implement Soft Delete** (AC: 3)
  - [ ] Update player record: `SET deleted_at = now()`
  - [ ] Call `playerService.softDeletePlayer(id)`
  - [ ] Update IndexedDB with deleted_at timestamp
  - [ ] Navigate to `/players`
  - [ ] Show toast with undo action

- [ ] **Task 4: Implement Undo Functionality** (AC: 4)
  - [ ] Show Material Snackbar with "Undo" action
  - [ ] Set 5-second duration
  - [ ] On undo click: Set `deleted_at = null`
  - [ ] Re-sync to Supabase immediately
  - [ ] Show "Deletion cancelled" toast

- [ ] **Task 5: Update Player List Query** (AC: 5)
  - [ ] Ensure all queries filter: `WHERE deleted_at IS NULL`
  - [ ] Verify soft-deleted players don't appear in lists
  - [ ] Confirm statistics queries still include deleted players

- [ ] **Task 6: Offline Handling** (AC: 6)
  - [ ] Check network status
  - [ ] If offline: Update IndexedDB only
  - [ ] Add soft-delete operation to sync queue
  - [ ] Sync when network available

- [ ] **Task 7: Write Unit Tests** (AC: 7)
  - [ ] Test soft delete sets deleted_at
  - [ ] Test undo restores player
  - [ ] Test deleted players excluded from queries
  - [ ] Test statistics preserved

- [ ] **Task 8: Write E2E Test** (AC: 8)
  - [ ] Navigate to player detail
  - [ ] Click delete button
  - [ ] Confirm deletion
  - [ ] Click undo in snackbar
  - [ ] Verify player still in list

## Dev Notes

### Soft Delete Pattern
Soft delete preserves data integrity:

```sql
UPDATE players
SET deleted_at = now()
WHERE id = $1;
```

**Benefits:**
- Statistics remain intact for historical accuracy
- Undo functionality possible
- Audit trail maintained
[Source: PRD Epic 2 Story 2.5 requirements]

### Query Filtering
All player queries must filter soft-deleted records:

```typescript
supabase
  .from('players')
  .select('*')
  .is('deleted_at', null);  // Exclude soft-deleted
```
[Source: architecture/9-database-schema.md]

### Undo Pattern with Snackbar
```typescript
const snackBar = this.snackBar.open('Player deleted', 'UNDO', {
  duration: 5000
});

snackBarRef.onAction().subscribe(() => {
  this.playerService.undoDelete(playerId);
});
```
[Source: Angular Material Snackbar documentation]

### Hard Delete (Future Consideration)
After 90 days, soft-deleted players can be hard-deleted:
- Manual admin action or
- Automated cleanup job (cron)
- Not implemented in MVP
[Source: PRD Epic 2 Story 2.5 AC #5]

## Dev Notes: Testing

### Unit Tests
**File:** `player.service.spec.ts`

Test cases:
- `softDeletePlayer()` sets deleted_at timestamp
- `undoDelete()` clears deleted_at
- Queries exclude soft-deleted players
- Statistics queries include soft-deleted players
[Source: architecture/16-testing-strategy.md]

### E2E Test
**File:** `tests/e2e/player-management.spec.ts`

```typescript
test('should delete and undo player deletion', async ({ page }) => {
  await page.goto('/players/123');
  await page.click('button:has-text("Delete")');
  await page.click('button:has-text("Delete")'); // Confirm

  await page.click('button:has-text("UNDO")');
  await page.goto('/players');

  await expect(page.locator('text=John Doe')).toBeVisible();
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation for Epic 2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
