# Story 2.6: Squad Management (Grouping Players)

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to organize players into squads (e.g., starters, substitutes),
**so that** I can quickly identify player roles

## Acceptance Criteria
1. ✅ `SquadManagementComponent` created (accessible from player list menu)
2. ✅ Displays three lists:
   - **Starters**: Players with `squad = 'starters'`
   - **Substitutes**: Players with `squad = 'substitutes'`
   - **Unassigned**: Players with `squad IS NULL`
3. ✅ Drag-and-drop interface:
   - Players can be dragged between lists
   - On drop, update `squad` field in player record
   - Visual feedback during drag (highlight drop zones)
4. ✅ Bulk actions:
   - "Select All" checkbox for each list
   - "Move Selected to Starters/Substitutes" buttons
5. ✅ On squad change:
   - Update player record in Supabase `players` table
   - Update IndexedDB (if offline, add to sync queue)
   - Set `updated_at = now()`
6. ✅ Offline handling:
   - Squad changes work offline
   - Changes queued for sync
7. ✅ Save button: Commits all changes (or auto-save on each drag-drop)
8. ✅ Cancel button: Reverts unsaved changes
9. ✅ Mobile optimization:
   - Drag-and-drop may be challenging on mobile, provide alternative: tap player → show "Move to..." dropdown
10. ✅ Unit test: Verify squad assignment logic
11. ✅ E2E test: Move player between squads, verify saved

## Tasks / Subtasks

- [ ] **Task 1: Generate SquadManagementComponent** (AC: 1)
  - [ ] Run: `ng generate component features/players/pages/squad-management`
  - [ ] Add route: `/players/squads`
  - [ ] Add menu item in player list toolbar

- [ ] **Task 2: Setup Three-Column Layout** (AC: 2)
  - [ ] Create three columns using CSS Grid or Flexbox
  - [ ] Column headers: "Starters", "Substitutes", "Unassigned"
  - [ ] Load and filter players by squad value
  - [ ] Display player cards in each column

- [ ] **Task 3: Implement Drag-and-Drop** (AC: 3)
  - [ ] Use Angular CDK Drag-Drop module: `@angular/cdk/drag-drop`
  - [ ] Create drop lists: `cdkDropList`
  - [ ] Make players draggable: `cdkDrag`
  - [ ] Handle drop event: `(cdkDropListDropped)="onDrop($event)"`
  - [ ] Update player's squad on drop
  - [ ] Add visual feedback (highlight on drag-over)

- [ ] **Task 4: Implement Bulk Actions** (AC: 4)
  - [ ] Add "Select All" checkbox for each list
  - [ ] Track selected players with Set<string>
  - [ ] Add action buttons: "Move to Starters", "Move to Substitutes"
  - [ ] Update multiple players' squad values in batch

- [ ] **Task 5: Implement Squad Update** (AC: 5)
  - [ ] On drop or bulk action: Call `playerService.updateSquad(playerId, squad)`
  - [ ] Update Supabase: `supabase.from('players').update({ squad }).eq('id', id)`
  - [ ] Update IndexedDB cache
  - [ ] Set `updated_at = now()`

- [ ] **Task 6: Offline Handling** (AC: 6)
  - [ ] Check network status
  - [ ] If offline: Update IndexedDB only
  - [ ] Add UPDATE operations to sync queue
  - [ ] Show offline indicator

- [ ] **Task 7: Add Save/Cancel Buttons** (AC: 7, 8)
  - [ ] Track pending changes in component state
  - [ ] Save button: Commit all pending changes to Supabase
  - [ ] Cancel button: Revert to original squad assignments
  - [ ] Alternatively: Auto-save on each drop

- [ ] **Task 8: Mobile Alternative UI** (AC: 9)
  - [ ] Detect mobile screen size: `@media (max-width: 768px)`
  - [ ] On mobile: Show single list with dropdown per player
  - [ ] Dropdown options: "Starters" | "Substitutes" | "Unassigned"
  - [ ] Update squad on dropdown change

- [ ] **Task 9: Write Unit Tests** (AC: 10)
  - [ ] Test squad filtering logic
  - [ ] Test drag-drop update
  - [ ] Test bulk actions
  - [ ] Test offline queue

- [ ] **Task 10: Write E2E Test** (AC: 11)
  - [ ] Navigate to squad management
  - [ ] Drag player from Unassigned to Starters
  - [ ] Verify player appears in Starters list
  - [ ] Reload page, verify change persisted

## Dev Notes

### Component Location
`/src/app/features/players/pages/squad-management/squad-management.component.ts`

### Angular CDK Drag-Drop
Install CDK if not already present:
```bash
ng add @angular/cdk
```

Import DragDropModule in component:
```typescript
import { CdkDragDrop, moveItemInArray, transferArrayItem } from '@angular/cdk/drag-drop';
```

**Template structure:**
```html
<div cdkDropListGroup>
  <div cdkDropList [cdkDropListData]="starters" (cdkDropListDropped)="onDrop($event)">
    <div *ngFor="let player of starters" cdkDrag>
      {{player.first_name}} {{player.last_name}}
    </div>
  </div>
  <!-- Repeat for substitutes and unassigned -->
</div>
```
[Source: Angular CDK documentation]

### Squad Update Logic
```typescript
async updateSquad(playerId: string, squad: 'starters' | 'substitutes' | null) {
  await this.supabase
    .from('players')
    .update({ squad, updated_at: new Date().toISOString() })
    .eq('id', playerId);

  // Update IndexedDB
  await this.db.players.update(playerId, { squad });
}
```

### Mobile Optimization
On mobile devices, drag-and-drop can be difficult. Provide alternative:
- Show dropdown menu: "Move to..."
- Options: Starters | Substitutes | Unassigned
- Update on selection change
[Source: PRD Epic 2 Story 2.6 AC #9]

### Auto-save vs Manual Save
**Recommended:** Auto-save on each drag-drop for better UX
**Alternative:** Batch changes with manual "Save" button

Auto-save provides immediate feedback and reduces chance of lost changes.

## Dev Notes: Testing

### Unit Tests
**File:** `squad-management.component.spec.ts`

Test cases:
- Players load into correct lists
- Drag-drop updates squad value
- Bulk actions update multiple players
- Offline changes queue for sync
[Source: architecture/16-testing-strategy.md]

### E2E Test
**File:** `tests/e2e/squad-management.spec.ts`

```typescript
test('should move player between squads', async ({ page }) => {
  await page.goto('/players/squads');

  // Drag player from Unassigned to Starters
  const player = page.locator('[data-testid="player-123"]');
  const startersList = page.locator('[data-testid="starters-list"]');
  await player.dragTo(startersList);

  // Verify player in Starters list
  await expect(startersList.locator('text=John Doe')).toBeVisible();
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation for Epic 2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
