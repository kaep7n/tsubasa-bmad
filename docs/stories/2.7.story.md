# Story 2.7: Player Statistics Service Foundation

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** developer,
**I want** a service to calculate per-player statistics,
**so that** player cards and detail screens can display stats

## Acceptance Criteria
1. ✅ `PlayerStatsService` created with methods:
   - `getPlayerStats(playerId: string): Observable<PlayerStats>` - Returns stats for a single player
   - `getAllPlayerStats(teamId: string): Observable<PlayerStats[]>` - Returns stats for all players
2. ✅ Statistics calculated:
   - Games played (count from `game_attendance` where status = 'attended')
   - Goals scored (count from `goals` where player_id = X)
   - Assists (count from `goal_assists` where player_id = X)
   - Attendance rate: (attended / total games) * 100
   - Training sessions attended (count from `training_attendance` where status = 'attended')
3. ✅ Queries run against IndexedDB for offline access:
   - Join `players` with `game_attendance`, `goals`, `goal_assists`, `training_attendance`
   - Use Dexie.js compound queries with indexes
4. ✅ Results cached in memory with TTL (5 minutes)
5. ✅ Cache invalidated on relevant data changes (new goal, attendance change, etc.)
6. ✅ Service exposes Signals for reactive updates: `playerStats()`
7. ✅ Unit test: Verify calculation accuracy with mock data
8. ✅ Performance test: Verify <100ms query time for 20 players, 50 games

## Tasks / Subtasks

- [ ] **Task 1: Create PlayerStatsService** (AC: 1)
  - [ ] Create `/src/app/features/players/services/player-stats.service.ts`
  - [ ] Implement `getPlayerStats(playerId)` method
  - [ ] Implement `getAllPlayerStats(teamId)` method
  - [ ] Inject DatabaseService (IndexedDB) and SupabaseService

- [ ] **Task 2: Define PlayerStats Interface** (AC: 2)
  - [ ] Create `/src/app/models/player-stats.model.ts`
  - [ ] Define interface with fields: gamesPlayed, goalsScored, assists, attendanceRate, trainingSessions
  - [ ] Add computed fields if needed (e.g., goalsPerGame)

- [ ] **Task 3: Implement Statistics Calculations** (AC: 2)
  - [ ] Count games played from `game_attendance` table
  - [ ] Count goals from `goals` table where `scorer_id = playerId`
  - [ ] Count assists from `goal_assists` table
  - [ ] Calculate attendance rate: (attended / total) * 100
  - [ ] Count training sessions attended

- [ ] **Task 4: Query IndexedDB with Dexie** (AC: 3)
  - [ ] Use Dexie compound queries with indexes
  - [ ] Example: `db.goals.where('player_id').equals(playerId).count()`
  - [ ] Join tables using Dexie relationships
  - [ ] Optimize with indexes on foreign keys

- [ ] **Task 5: Implement In-Memory Cache with TTL** (AC: 4)
  - [ ] Create cache Map: `Map<string, { stats: PlayerStats, timestamp: number }>`
  - [ ] Set TTL: 5 minutes (300,000ms)
  - [ ] Check cache before querying database
  - [ ] Return cached data if fresh

- [ ] **Task 6: Implement Cache Invalidation** (AC: 5)
  - [ ] Invalidate cache when new goal added
  - [ ] Invalidate when attendance marked
  - [ ] Invalidate when player updated
  - [ ] Listen to data change events

- [ ] **Task 7: Expose Reactive State with Signals** (AC: 6)
  - [ ] Create Signal: `playerStats = signal<Map<string, PlayerStats>>(new Map())`
  - [ ] Update signal when stats recalculated
  - [ ] Components can subscribe: `playerStats().get(playerId)`

- [ ] **Task 8: Write Unit Tests** (AC: 7)
  - [ ] Mock IndexedDB data
  - [ ] Test calculation accuracy for each stat
  - [ ] Test cache hit/miss logic
  - [ ] Test cache invalidation
  - [ ] Verify stats match expected values

- [ ] **Task 9: Write Performance Tests** (AC: 8)
  - [ ] Create test with 20 players, 50 games
  - [ ] Measure query execution time
  - [ ] Assert query completes in <100ms
  - [ ] Test with larger datasets (stress test)

## Dev Notes

### Service Location
`/src/app/features/players/services/player-stats.service.ts`

This service is a **foundation** for future statistics features. It will be used by:
- Player List View (Story 2.2) - show quick stats
- Player Detail Screen (future story)
- Statistics Dashboard (Epic 6)

### Statistics Model
```typescript
interface PlayerStats {
  playerId: string;
  gamesPlayed: number;
  goalsScored: number;
  assists: number;
  attendanceRate: number;  // Percentage: 0-100
  trainingSessionsAttended: number;

  // Computed fields
  goalsPerGame?: number;
  lastUpdated: Date;
}
```
[Source: PRD Epic 2 Story 2.7 AC #2]

### Dexie.js Queries
Use Dexie for efficient IndexedDB queries:

```typescript
async getPlayerStats(playerId: string): Promise<PlayerStats> {
  const goalsScored = await this.db.goals
    .where('scorer_id').equals(playerId)
    .count();

  const assists = await this.db.goalAssists
    .where('player_id').equals(playerId)
    .count();

  const gamesPlayed = await this.db.gameAttendance
    .where({ player_id: playerId, status: 'attended' })
    .count();

  // Calculate attendance rate
  const totalGames = await this.db.games.count();
  const attendanceRate = (gamesPlayed / totalGames) * 100;

  return { playerId, goalsScored, assists, gamesPlayed, attendanceRate };
}
```
[Source: architecture/3-tech-stack.md: "IndexedDB (Dexie.js)"]

### Cache Implementation with TTL
```typescript
private cache = new Map<string, { stats: PlayerStats, timestamp: number }>();
private TTL = 5 * 60 * 1000; // 5 minutes

getPlayerStats(playerId: string): Observable<PlayerStats> {
  const cached = this.cache.get(playerId);
  if (cached && (Date.now() - cached.timestamp < this.TTL)) {
    return of(cached.stats);
  }

  // Query and update cache
  return this.queryStats(playerId).pipe(
    tap(stats => this.cache.set(playerId, { stats, timestamp: Date.now() }))
  );
}
```

### Cache Invalidation Strategy
Invalidate cache when underlying data changes:
- New goal scored → Invalidate player's stats
- Attendance marked → Invalidate player's stats
- Player updated → Invalidate player's stats

Listen to data change events from services.

### Performance Optimization
**Indexes required** for fast queries:
- `goals`: Index on `scorer_id`
- `goal_assists`: Index on `player_id`
- `game_attendance`: Composite index on `(player_id, status)`
- `training_attendance`: Composite index on `(player_id, status)`

[Source: architecture/9-database-schema.md: "Comprehensive indexes"]

## Dev Notes: Testing

### Unit Tests
**File:** `player-stats.service.spec.ts`

Test cases:
- Stats calculated correctly with mock data
- Cache returns stored value within TTL
- Cache expired after TTL, re-queries data
- Cache invalidated on data change
- All calculations accurate (goals, assists, attendance)
[Source: architecture/16-testing-strategy.md]

### Performance Test
```typescript
it('should calculate stats for 20 players in <100ms', async () => {
  const startTime = performance.now();
  await service.getAllPlayerStats(teamId).toPromise();
  const duration = performance.now() - startTime;

  expect(duration).toBeLessThan(100);
});
```

### Test Data Setup
Create helper to populate IndexedDB with test data:
- 20 players
- 50 games
- 100 goals
- 200 attendance records

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation for Epic 2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
