# Story 3.1: Training Sessions Database Schema

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** developer,
**I want** the training sessions database schema created,
**so that** training data can be stored and attendance tracked

## Acceptance Criteria
1. ✅ Migration file created with `training_templates` table
2. ✅ Migration file created with `training_sessions` table
3. ✅ Migration file created with `training_attendance` table
4. ✅ RLS policies enabled on all three tables (team_id isolation via joins)
5. ✅ Indexes created for performance
6. ✅ Trigger added: Update `updated_at` on row modification
7. ✅ Migration applied: `supabase db push`
8. ✅ TypeScript types generated: `supabase gen types typescript`
9. ✅ pgTAP tests verify schema constraints and RLS policies

## Tasks / Subtasks

- [x] **Task 1: Create Training Templates Table** (AC: 1)
  - [x] Generate migration: `supabase migration new create_training_tables`
  - [x] Add SQL for training_templates table:
    - id, team_id, name, default_duration_minutes, default_location
    - created_at, updated_at
  - [x] Add foreign key: team_id → teams(id) ON DELETE CASCADE
  - [x] Add check constraint: default_duration_minutes > 0

- [x] **Task 2: Create Training Sessions Table** (AC: 2)
  - [x] Add SQL for training_sessions table:
    - id, team_id, session_template_id, date, duration_minutes, location, notes
    - created_at, updated_at, deleted_at
  - [x] Add foreign keys: team_id → teams, session_template_id → training_templates (nullable)
  - [x] Add check constraint: duration_minutes > 0

- [x] **Task 3: Create Training Attendance Table** (AC: 3)
  - [x] Add SQL for training_attendance table:
    - id, training_session_id, player_id, status
    - created_at, updated_at
  - [x] Add CHECK constraint: status IN ('attended', 'excused', 'absent')
  - [x] Add UNIQUE constraint: (training_session_id, player_id)
  - [x] Add foreign keys with CASCADE deletes

- [x] **Task 4: Create Indexes** (AC: 5)
  - [x] CREATE INDEX idx_training_sessions_team_date ON training_sessions(team_id, date DESC)
  - [x] CREATE INDEX idx_training_attendance_session ON training_attendance(training_session_id)
  - [x] CREATE INDEX idx_training_attendance_player ON training_attendance(player_id)

- [x] **Task 5: Create Updated_at Triggers** (AC: 6)
  - [x] Apply trigger to training_templates
  - [x] Apply trigger to training_sessions
  - [x] Apply trigger to training_attendance

- [x] **Task 6: Enable RLS and Create Policies** (AC: 4)
  - [x] Enable RLS on all three tables
  - [x] Create policies for training_templates (team_id check)
  - [x] Create policies for training_sessions (team_id check)
  - [x] Create policies for training_attendance (via join to training_sessions.team_id)

- [x] **Task 7: Apply Migration** (AC: 7)
  - [x] Run `supabase db push`
  - [x] Verify in Supabase dashboard

- [x] **Task 8: Generate TypeScript Types** (AC: 8)
  - [x] Run `supabase gen types typescript --local > src/app/models/supabase.types.ts`
  - [x] Create model files: training-session.model.ts, training-attendance.model.ts

- [x] **Task 9: Create pgTAP Tests** (AC: 9)
  - [x] Test schema constraints
  - [x] Test RLS policies
  - [x] Test cascade deletes
  - [x] Run: `supabase test db`

## Dev Notes

### Database Schema

**training_templates table:**
```sql
CREATE TABLE training_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID REFERENCES teams(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  default_duration_minutes INTEGER DEFAULT 90 CHECK (default_duration_minutes > 0),
  default_location TEXT,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

**training_sessions table:**
```sql
CREATE TABLE training_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID REFERENCES teams(id) ON DELETE CASCADE NOT NULL,
  session_template_id UUID REFERENCES training_templates(id) ON DELETE SET NULL,
  date TIMESTAMPTZ NOT NULL,
  duration_minutes INTEGER DEFAULT 90 CHECK (duration_minutes > 0),
  location TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  deleted_at TIMESTAMPTZ
);
```

**training_attendance table:**
```sql
CREATE TABLE training_attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  training_session_id UUID REFERENCES training_sessions(id) ON DELETE CASCADE NOT NULL,
  player_id UUID REFERENCES players(id) ON DELETE CASCADE NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('attended', 'excused', 'absent')),
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  UNIQUE(training_session_id, player_id)
);
```
[Source: architecture/4-data-models.md, PRD Epic 3 Story 3.1]

### Three-State Attendance Pattern
The three-state attendance system provides granular tracking:
- **Attended**: Player was present
- **Excused**: Player provided valid absence reason
- **Absent**: Player did not attend without excuse

This allows coaches to differentiate between unexcused absences and legitimate reasons.
[Source: PRD Epic 3 requirements]

## Dev Notes: Testing

Test schema integrity and RLS isolation.

**File:** `supabase/tests/training_tables.test.sql`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation for Epic 3 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
