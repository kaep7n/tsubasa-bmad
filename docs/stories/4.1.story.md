# Story 4.1: Games Database Schema

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** developer,
**I want** the games database schema created,
**so that** game data can be stored and tracked

## Acceptance Criteria
1. ✅ Migration file: `games` table with all required fields
2. ✅ Migration file: `game_attendance` table with unique constraint
3. ✅ RLS policies: team_id isolation via joins
4. ✅ Indexes: Optimized for chronological and sync queries
5. ✅ Trigger: Update `updated_at` on modification
6. ✅ Trigger: Set `is_protected = true` when goals or attendance exist
7. ✅ Migration applied: `supabase db push`
8. ✅ TypeScript types generated
9. ✅ pgTAP tests: Schema constraints, triggers, RLS policies

## Tasks / Subtasks

- [x] **Task 1: Create Games Table Migration** (AC: 1)
  - [x] Create migration file in supabase/migrations/
  - [x] Define games table schema:
    - id (uuid, primary key, default: gen_random_uuid())
    - team_id (uuid, foreign key to teams, not null)
    - opponent (text, not null)
    - date (timestamptz, not null)
    - location (text, nullable)
    - home_away (text, CHECK: 'home' | 'away')
    - status (text, default: 'scheduled', CHECK: 'scheduled' | 'in_progress' | 'completed' | 'cancelled')
    - final_score_team (int, nullable)
    - final_score_opponent (int, nullable)
    - result (text, CHECK: 'win' | 'draw' | 'loss')
    - calendar_sync_id (text, nullable)
    - is_protected (boolean, default: false)
    - created_at, updated_at, deleted_at

- [x] **Task 2: Create Game Attendance Table Migration** (AC: 2)
  - [x] Define game_attendance table schema:
    - id (uuid, primary key)
    - game_id (uuid, foreign key to games, CASCADE)
    - player_id (uuid, foreign key to players, CASCADE)
    - status (text, CHECK: 'attended' | 'excused' | 'absent')
    - created_at, updated_at
  - [x] Add UNIQUE constraint: (game_id, player_id)

- [x] **Task 3: Create Indexes** (AC: 4)
  - [x] Index: games(team_id, date) for chronological queries
  - [x] Index: games(calendar_sync_id) for Google Calendar sync
  - [x] Index: game_attendance(game_id) for attendance lookups
  - [x] Index: game_attendance(player_id) for player history

- [x] **Task 4: Implement RLS Policies** (AC: 3)
  - [x] Enable RLS on games table
  - [x] Policy: SELECT WHERE team_id IN (user's teams)
  - [x] Policy: INSERT WHERE team_id IN (user's teams)
  - [x] Policy: UPDATE WHERE team_id IN (user's teams)
  - [x] Policy: DELETE WHERE team_id IN (user's teams)
  - [x] Enable RLS on game_attendance table
  - [x] Policy: Access via games.team_id join

- [x] **Task 5: Create Triggers** (AC: 5, 6)
  - [x] Trigger: updated_at = now() on games UPDATE
  - [x] Trigger: updated_at = now() on game_attendance UPDATE
  - [x] Trigger: Set is_protected = true when attendance or goals added

- [x] **Task 6: Apply Migration** (AC: 7, 8)
  - [x] Run: supabase db push
  - [x] Run: supabase gen types typescript --local > src/app/models/supabase.types.ts
  - [x] Verify types in TypeScript

- [x] **Task 7: Write pgTAP Tests** (AC: 9)
  - [x] Test: Schema constraints (CHECK, UNIQUE, FK)
  - [x] Test: RLS policies isolate by team_id
  - [x] Test: updated_at trigger fires
  - [x] Test: is_protected trigger fires

## Dev Notes

Database schema location: `supabase/migrations/`

Protected games pattern prevents accidental deletion of games with recorded data (attendance or goals).

Soft delete pattern using `deleted_at` preserves historical data.

Three-state attendance: 'attended' | 'excused' | 'absent'

Calendar sync integration uses `calendar_sync_id` to map to Google Calendar event IDs.

[Source: PRD Epic 4 Story 4.1, Architecture Section 4 Database Design]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
