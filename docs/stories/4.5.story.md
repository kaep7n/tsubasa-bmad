# Story 4.5: Cancel Game

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to cancel a game if it's called off,
**so that** my schedule reflects reality

## Acceptance Criteria
1. ✅ "Cancel Game" button on game detail screen
2. ✅ Confirmation dialog with preservation message
3. ✅ On confirm: Set status='cancelled', update calendar, navigate back, show undo toast
4. ✅ Undo functionality: Restore within 5 seconds
5. ✅ Protected games: Show additional warning
6. ✅ Cancelled games: Shown in list with "Cancelled" badge, can be filtered
7. ✅ Offline handling: Cancellation works offline
8. ✅ Unit test: Verify cancellation logic and protected handling
9. ✅ E2E test: Cancel game, undo, verify restored

## Tasks / Subtasks

- [ ] **Task 1: Add Cancel Button** (AC: 1)
  - [ ] Add button to game detail screen
  - [ ] Style with warn color

- [ ] **Task 2: Create Confirmation Dialog** (AC: 2, 5)
  - [ ] Material Dialog component
  - [ ] Title: "Cancel this game?"
  - [ ] Message: "If attendance or goals have been recorded, they will be preserved but marked as cancelled. This action can be undone."
  - [ ] If is_protected = true: Add warning text
  - [ ] Actions: Keep Game | Cancel Game

- [ ] **Task 3: Implement Cancellation** (AC: 3)
  - [ ] Update: SET status = 'cancelled'
  - [ ] Update IndexedDB
  - [ ] If calendar_sync_id: Update Google Calendar event title to "[CANCELLED] {opponent}"
  - [ ] Navigate back
  - [ ] Show snackbar with undo: "Game cancelled" [Undo]

- [ ] **Task 4: Implement Undo** (AC: 4)
  - [ ] 5-second snackbar with Undo action
  - [ ] On undo: SET status = 'scheduled'
  - [ ] Re-sync to Supabase and Google Calendar
  - [ ] Show toast: "Cancellation undone"

- [ ] **Task 5: Update List Display** (AC: 6)
  - [ ] Display "Cancelled" badge in game list
  - [ ] Filter: Exclude from "Upcoming" and "Past"
  - [ ] Include in "Cancelled" filter

- [ ] **Task 6: Offline Handling** (AC: 7)
  - [ ] Queue cancel operation when offline
  - [ ] Queue calendar update separately

- [ ] **Task 7: Write Tests** (AC: 8, 9)
  - [ ] Unit test cancellation
  - [ ] Unit test undo
  - [ ] Unit test protected game warning
  - [ ] E2E test cancel and undo

## Dev Notes

Status-based cancellation (not soft delete) preserves attendance and goals for statistics while marking the game as cancelled.

Protected games have `is_protected = true` when attendance or goals exist, preventing accidental data loss.

Calendar sync update:
```typescript
if (game.calendar_sync_id) {
  await this.googleCalendarService.updateEvent(
    game.calendar_sync_id,
    { summary: `[CANCELLED] ${game.opponent}` }
  );
}
```

Undo pattern:
```typescript
const snackBarRef = this.snackBar.open('Game cancelled', 'Undo', { duration: 5000 });
snackBarRef.onAction().subscribe(() => {
  this.gamesService.uncancelGame(gameId);
});
```

[Source: PRD Epic 4 Story 4.5, Architecture Section 8 State Management]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
