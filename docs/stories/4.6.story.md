# Story 4.6: Calendar Import (iCal File Upload)

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to import games from an iCal (.ics) file,
**so that** I don't have to manually enter my league schedule

## Acceptance Criteria
1. ✅ "Import Calendar" button opens import modal with two options
2. ✅ iCal file upload flow with file input
3. ✅ Parse iCal using library (e.g., `ical.js`)
4. ✅ Extract events, filter out training/practice heuristics
5. ✅ Display preview list with checkboxes
6. ✅ Allow editing opponent name before import
7. ✅ On import: Batch insert to Supabase, save to IndexedDB, show toast
8. ✅ Error handling: Invalid file, no events, duplicates
9. ✅ Offline handling: Import works offline
10. ✅ Unit test: Verify iCal parsing with sample .ics
11. ✅ E2E test: Upload .ics, verify games imported

## Tasks / Subtasks

- [ ] **Task 1: Create Import Modal Component** (AC: 1)
  - [ ] Generate component: `CalendarImportModalComponent`
  - [ ] Two options: "Upload iCal File (.ics)", "Connect Google Calendar"
  - [ ] Material Dialog wrapper

- [ ] **Task 2: Implement File Upload** (AC: 2)
  - [ ] File input with accept=".ics"
  - [ ] Read file as text
  - [ ] Trigger parsing on file select

- [ ] **Task 3: Parse iCal File** (AC: 3, 4)
  - [ ] Install: `npm install ical.js`
  - [ ] Parse iCal content
  - [ ] Extract events with VEVENT component
  - [ ] Filter out events with titles containing: "training", "practice", "meeting"
  - [ ] Extract: title (opponent), dtstart (date/time), location, uid

- [ ] **Task 4: Build Preview List** (AC: 5, 6)
  - [ ] Display table with columns: Checkbox, Opponent (editable), Date, Time, Location
  - [ ] All checkboxes default: checked
  - [ ] Allow editing opponent name in-line
  - [ ] "Import Selected" button

- [ ] **Task 5: Implement Batch Import** (AC: 7)
  - [ ] Generate UUIDs for selected events
  - [ ] Batch insert to Supabase games table
  - [ ] Save to IndexedDB (if offline, queue sync)
  - [ ] Navigate back to game list
  - [ ] Show toast: "{N} games imported"

- [ ] **Task 6: Error Handling** (AC: 8)
  - [ ] Invalid .ics file: Show error "Unable to parse file"
  - [ ] No events found: Show error "No games found in calendar"
  - [ ] Duplicate detection: Check existing games by opponent + date
  - [ ] Show warning: "X games already exist. Skip or override?"

- [ ] **Task 7: Offline Handling** (AC: 9)
  - [ ] Import works offline
  - [ ] Save to IndexedDB, queue sync

- [ ] **Task 8: Write Tests** (AC: 10, 11)
  - [ ] Unit test: Parse sample .ics file
  - [ ] Unit test: Filter heuristics
  - [ ] Unit test: Duplicate detection
  - [ ] E2E test: Upload and import

## Dev Notes

Component location: `/src/app/features/games/components/calendar-import-modal/`

iCal parsing library: `ical.js` (https://github.com/kewisch/ical.js)

Example iCal event parsing:
```typescript
import ICAL from 'ical.js';

const jcalData = ICAL.parse(icsContent);
const comp = new ICAL.Component(jcalData);
const vevents = comp.getAllSubcomponents('vevent');

vevents.forEach(vevent => {
  const event = new ICAL.Event(vevent);
  const opponent = event.summary; // Event title
  const date = event.startDate.toJSDate();
  const location = event.location;
});
```

Heuristic filtering prevents importing training sessions or meetings that appear in the same calendar.

Duplicate detection:
```typescript
const existingGame = await this.gamesService.findByOpponentAndDate(opponent, date);
if (existingGame) {
  // Show warning
}
```

[Source: PRD Epic 4 Story 4.6, Architecture Section 9 Third-Party Integrations]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
