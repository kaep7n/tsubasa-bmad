# Story 4.7: Google Calendar OAuth Integration

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to connect my Google Calendar,
**so that** games are automatically synced from my calendar

## Acceptance Criteria
1. ✅ "Connect Google Calendar" button in import modal
2. ✅ OAuth flow: Google consent screen with calendar.readonly scope
3. ✅ Tokens stored securely in Supabase Auth user metadata
4. ✅ Calendar selection modal: Display user's calendar list
5. ✅ `GoogleCalendarSyncService` with syncGames() method
6. ✅ Sync: Fetch events, filter heuristics, extract data, save to Supabase
7. ✅ Incremental sync: Store last_calendar_sync_at, only fetch modified events
8. ✅ Token refresh: Automatic via Supabase Auth
9. ✅ Disconnect calendar: Revoke tokens, clear metadata
10. ✅ Offline handling: OAuth and sync require online (show error)
11. ✅ Unit test: Verify event parsing and duplicate detection
12. ✅ E2E test: Connect calendar, verify games synced

## Tasks / Subtasks

- [ ] **Task 1: Setup Google OAuth** (AC: 1, 2, 3)
  - [ ] Create Google Cloud project, enable Calendar API
  - [ ] Configure OAuth consent screen
  - [ ] Create OAuth credentials (Web application)
  - [ ] Add to Supabase Auth providers
  - [ ] Scope: `https://www.googleapis.com/auth/calendar.readonly`
  - [ ] Store tokens in auth.users metadata

- [ ] **Task 2: Implement OAuth Flow** (AC: 1, 2)
  - [ ] "Connect Google Calendar" button
  - [ ] Trigger: supabase.auth.signInWithOAuth({ provider: 'google', options: { scopes: 'calendar.readonly' } })
  - [ ] Handle callback
  - [ ] Store access_token and refresh_token

- [ ] **Task 3: Calendar Selection** (AC: 4)
  - [ ] Fetch calendar list: GET https://www.googleapis.com/calendar/v3/users/me/calendarList
  - [ ] Display modal with dropdown
  - [ ] User selects calendar, taps "Sync"

- [ ] **Task 4: Create GoogleCalendarSyncService** (AC: 5, 6)
  - [ ] Generate service: `ng generate service core/services/google-calendar-sync`
  - [ ] Method: syncGames(calendarId: string)
  - [ ] Fetch events: GET https://www.googleapis.com/calendar/v3/calendars/{calendarId}/events
  - [ ] Date range: today to +6 months
  - [ ] Filter: Exclude titles with "training", "practice", "meeting"
  - [ ] Extract: opponent, date, time, location, event ID
  - [ ] Compare by calendar_sync_id to avoid duplicates

- [ ] **Task 5: Implement Incremental Sync** (AC: 7)
  - [ ] Store last_calendar_sync_at in teams table
  - [ ] Fetch events with updatedMin = last_calendar_sync_at
  - [ ] Update existing games if calendar event changed
  - [ ] Update last_calendar_sync_at after sync

- [ ] **Task 6: Token Management** (AC: 8)
  - [ ] Refresh token handled automatically by Supabase Auth
  - [ ] Handle revoked tokens: Show error "Google Calendar access revoked. Please reconnect."

- [ ] **Task 7: Disconnect Calendar** (AC: 9)
  - [ ] "Disconnect Google Calendar" button in settings
  - [ ] Revoke tokens: POST https://oauth2.googleapis.com/revoke
  - [ ] Clear calendar sync metadata
  - [ ] Preserve existing games (don't delete)

- [ ] **Task 8: Offline Handling** (AC: 10)
  - [ ] Check network status before OAuth flow
  - [ ] Show error: "Calendar sync requires internet connection"

- [ ] **Task 9: Write Tests** (AC: 11, 12)
  - [ ] Unit test: Parse Google Calendar event
  - [ ] Unit test: Duplicate detection by calendar_sync_id
  - [ ] Unit test: Incremental sync logic
  - [ ] E2E test: Connect and sync (mocked)

## Dev Notes

Service location: `/src/app/core/services/google-calendar-sync.service.ts`

Google Calendar API documentation: https://developers.google.com/calendar/api/v3/reference

OAuth flow via Supabase Auth simplifies token management and refresh.

Example event fetch:
```typescript
const response = await fetch(
  `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?` +
  `timeMin=${new Date().toISOString()}&` +
  `timeMax=${sixMonthsLater.toISOString()}&` +
  `singleEvents=true&orderBy=startTime`,
  { headers: { Authorization: `Bearer ${accessToken}` } }
);
const { items } = await response.json();
```

Event filtering:
```typescript
const games = items.filter(event => {
  const title = event.summary.toLowerCase();
  return !title.includes('training') && !title.includes('practice') && !title.includes('meeting');
});
```

Duplicate check:
```typescript
const existingGame = await this.gamesService.findByCalendarSyncId(event.id);
if (existingGame) {
  // Update existing game
} else {
  // Insert new game
}
```

[Source: PRD Epic 4 Story 4.7, Architecture Section 9.2 Google Calendar Integration]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
