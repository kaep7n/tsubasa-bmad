# Story 4.8: Calendar Backfill (Historical Games)

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to import past games from my calendar,
**so that** I can track historical data

## Acceptance Criteria
1. ✅ "Backfill Historical Games" option in Google Calendar sync modal
2. ✅ Checkbox: "Include past games" (default: unchecked)
3. ✅ Date range picker: Start Date, End Date
4. ✅ On sync with backfill: Fetch events in date range, filter, import
5. ✅ Historical games: Mark as status='completed' if date < today
6. ✅ Historical games: No final score or attendance backfilled
7. ✅ Performance: Batch API requests if >100 events
8. ✅ Progress indicator: "Importing... {N} games processed"
9. ✅ Offline handling: Backfill requires online connection
10. ✅ Unit test: Verify date range filtering and status assignment
11. ✅ E2E test: Backfill 10 historical games, verify imported as completed

## Tasks / Subtasks

- [ ] **Task 1: Add Backfill UI** (AC: 1, 2, 3)
  - [ ] Add checkbox: "Include past games" (default: unchecked)
  - [ ] Show date range pickers when checked
  - [ ] Default start date: 6 months ago
  - [ ] Default end date: today

- [ ] **Task 2: Implement Backfill Logic** (AC: 4, 5)
  - [ ] Extend syncGames() with optional date range params
  - [ ] Fetch events: timeMin = startDate, timeMax = endDate
  - [ ] Filter events as in Story 4.7
  - [ ] If event date < today: Set status = 'completed'
  - [ ] If event date >= today: Set status = 'scheduled'

- [ ] **Task 3: Handle Historical Games** (AC: 6)
  - [ ] Import with status = 'completed'
  - [ ] Leave final_score_team, final_score_opponent, result as null
  - [ ] Leave attendance empty (no backfill)
  - [ ] Coach can manually edit later

- [ ] **Task 4: Batch API Requests** (AC: 7)
  - [ ] Google Calendar API limit: 2500 events per page
  - [ ] Implement pagination with pageToken
  - [ ] Batch process in chunks of 100

- [ ] **Task 5: Add Progress Indicator** (AC: 8)
  - [ ] Show modal: "Importing... {N} games processed"
  - [ ] Update progress as each batch completes
  - [ ] Close modal on completion

- [ ] **Task 6: Offline Handling** (AC: 9)
  - [ ] Check network status
  - [ ] Show error: "Backfill requires internet connection"
  - [ ] Disable checkbox if offline

- [ ] **Task 7: Write Tests** (AC: 10, 11)
  - [ ] Unit test: Date range filtering
  - [ ] Unit test: Status assignment (completed vs scheduled)
  - [ ] Unit test: Pagination logic
  - [ ] E2E test: Backfill historical games (mocked)

## Dev Notes

Service location: Update `/src/app/core/services/google-calendar-sync.service.ts`

Backfill method signature:
```typescript
async syncGames(
  calendarId: string,
  options?: { startDate?: Date; endDate?: Date }
): Promise<number>
```

Date range fetch:
```typescript
const timeMin = options?.startDate?.toISOString() || new Date().toISOString();
const timeMax = options?.endDate?.toISOString() || sixMonthsLater.toISOString();
```

Status assignment:
```typescript
const status = new Date(event.start.dateTime) < new Date() ? 'completed' : 'scheduled';
```

Pagination:
```typescript
let pageToken: string | undefined;
do {
  const response = await fetch(
    `${baseUrl}?pageToken=${pageToken}&maxResults=100`,
    { headers }
  );
  const { items, nextPageToken } = await response.json();
  pageToken = nextPageToken;
  // Process items
} while (pageToken);
```

Historical games can be manually enhanced by coach:
- Edit final score
- Mark attendance retroactively

[Source: PRD Epic 4 Story 4.8, Architecture Section 9.2 Google Calendar Integration]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
