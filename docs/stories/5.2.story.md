# Story 5.2: Game Timer with Background Persistence

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** the game timer to continue running even when my phone is locked or I switch apps,
**so that** game time remains accurate throughout the match

## Acceptance Criteria
1. ✅ `GameTimerService` created using Web Worker for background execution
2. ✅ Timer tracks: current minute, elapsed time, paused/running state, half-time detection
3. ✅ Timer state persists to IndexedDB every 5 seconds
4. ✅ Timer resumes from last known state on app reopen
5. ✅ Signals exposed: `currentMinute()`, `isRunning()`, `isHalfTime()`
6. ✅ Timer handles edge cases: sleep/wake, backgrounding, tab switching, page refresh
7. ✅ Manual adjustments supported: pause, resume, set minute
8. ✅ Unit test: Verify timer accuracy and persistence
9. ✅ E2E test: Timer survives page reload

## Tasks / Subtasks

- [ ] **Task 1: Generate GameTimerService** (AC: 1)
  - [ ] Run: `ng generate service core/services/game-timer`
  - [ ] Create Web Worker: `game-timer.worker.ts`
  - [ ] Initialize worker in service

- [ ] **Task 2: Implement Timer Logic** (AC: 2, 7)
  - [ ] Track current game minute (0-90+)
  - [ ] Track elapsed real time (ms precision)
  - [ ] Track paused/running state
  - [ ] Detect half-time at 45 minutes (configurable)
  - [ ] Methods: start(), pause(), resume(), setMinute(n)

- [ ] **Task 3: Implement Persistence** (AC: 3, 4)
  - [ ] Auto-save timer state to IndexedDB every 5 seconds
  - [ ] Schema: { gameId, currentMinute, startedAt, pausedAt, isRunning, isHalfTime }
  - [ ] On service init: Load last state from IndexedDB
  - [ ] Resume timer if was running

- [ ] **Task 4: Create Reactive Signals** (AC: 5)
  - [ ] Signal: currentMinute (number)
  - [ ] Signal: isRunning (boolean)
  - [ ] Signal: isHalfTime (boolean)
  - [ ] Update signals on worker message

- [ ] **Task 5: Handle Edge Cases** (AC: 6)
  - [ ] Listen to Page Visibility API
  - [ ] On visibility change: Compare expected vs actual time
  - [ ] Correct drift on wake from background
  - [ ] Persist on beforeunload event

- [ ] **Task 6: Write Tests** (AC: 8, 9)
  - [ ] Unit test: Timer increments correctly
  - [ ] Unit test: Persistence saves and restores
  - [ ] Unit test: Manual adjustments work
  - [ ] E2E test: Start timer, reload page, verify continues

## Dev Notes

Service location: `/src/app/core/services/game-timer.service.ts`

Web Worker location: `/src/app/core/workers/game-timer.worker.ts`

Web Worker pattern enables timer to run independently of Angular change detection, improving performance during live game tracking.

Timer persistence schema:
```typescript
interface TimerState {
  gameId: string;
  currentMinute: number;
  startedAt: number; // Unix timestamp
  pausedAt: number | null;
  isRunning: boolean;
  isHalfTime: boolean;
}
```

Page Visibility API for background handling:
```typescript
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    this.resumeAndCorrectDrift();
  }
});
```

Timer accuracy requirement: ±1 second per 90-minute game.

[Source: PRD Epic 5 Story 5.2, Architecture Section 8 State Management]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
