# Story 5.8: Undo/Edit Goal Functionality

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to undo or edit goals if I make a mistake,
**so that** the game record remains accurate

## Acceptance Criteria
1. ✅ "Undo" toast action appears for 5 seconds after logging goal
2. ✅ Tapping "Undo" within 5 seconds: soft delete, revert scoreboard, remove from timeline, queue sync
3. ✅ Edit icon on timeline events opens edit modal
4. ✅ Edit modal: Change scorer, add/remove assists, adjust minute, add notes
5. ✅ Save edits: Update record, set updated_at, sync_state='pending', re-sync
6. ✅ Delete icon on timeline events: Show confirmation, soft delete on confirm
7. ✅ Deleted goals sync to backend (soft delete, not hard delete)
8. ✅ E2E test: Log goal, undo within 5 seconds, verify scoreboard reverts
9. ✅ E2E test: Edit goal scorer, verify DB and timeline update

## Tasks / Subtasks

- [ ] **Task 1: Add Undo Action to Toast** (AC: 1)
  - [ ] After logging goal, show snackbar with "Undo" action
  - [ ] Duration: 5000ms
  - [ ] Action: "Undo"

- [ ] **Task 2: Implement Undo Logic** (AC: 2)
  - [ ] On undo action clicked:
    - Set goal.deleted_at = new Date()
    - Update goal.sync_state = 'pending'
    - Save to IndexedDB
    - Add delete operation to sync queue
    - Decrement team score signal
    - Remove from timeline
    - Show confirmation toast: "Goal undone"

- [ ] **Task 3: Add Edit Icon to Timeline Events** (AC: 3)
  - [ ] Edit icon button (pencil icon) on right side of event
  - [ ] Click opens edit modal
  - [ ] Pass goal data to modal

- [ ] **Task 4: Create Edit Goal Modal** (AC: 4)
  - [ ] Generate component: `EditGoalModalComponent`
  - [ ] Form fields:
    - Scorer (dropdown, all players)
    - Assists (multi-select, all players except scorer)
    - Minute (number input, 1-120)
    - Notes (textarea, optional)
  - [ ] Pre-populate with existing goal data

- [ ] **Task 5: Implement Save Edits** (AC: 5)
  - [ ] Update goal record:
    - player_id, scored_at_minute, notes
    - updated_at = new Date()
    - sync_state = 'pending'
  - [ ] Update goal_assists:
    - Delete removed assists (soft delete)
    - Insert new assists
  - [ ] Save to IndexedDB
  - [ ] Add to sync queue
  - [ ] Update timeline
  - [ ] Show toast: "Goal updated"

- [ ] **Task 6: Add Delete Icon to Timeline Events** (AC: 6)
  - [ ] Delete icon button (trash icon)
  - [ ] Click shows confirmation dialog:
    - Title: "Delete this goal?"
    - Actions: Cancel | Delete
  - [ ] On confirm: Soft delete (same as undo logic)

- [ ] **Task 7: Implement Soft Delete Sync** (AC: 7)
  - [ ] Sync service: Send deleted_at timestamp to backend
  - [ ] Backend: Mark as deleted, don't hard delete
  - [ ] Statistics queries: Exclude deleted_at IS NOT NULL

- [ ] **Task 8: Write Tests** (AC: 8, 9)
  - [ ] E2E test: Log goal, tap undo within 5 seconds
  - [ ] E2E test: Verify scoreboard decrements
  - [ ] E2E test: Verify timeline removes event
  - [ ] E2E test: Edit goal scorer, verify update
  - [ ] E2E test: Edit minute, verify timeline re-sorts

## Dev Notes

Component location: `/src/app/features/games/components/edit-goal-modal/`

Soft delete pattern preserves data integrity for statistics and audit trails.

Undo toast pattern:
```typescript
const snackBarRef = this.snackBar.open(
  `Goal by ${player.name} - ${minute}'`,
  'Undo',
  { duration: 5000 }
);

snackBarRef.onAction().subscribe(() => {
  this.goalsService.undoGoal(goalId);
});
```

Soft delete:
```typescript
async undoGoal(goalId: string) {
  await this.db.goals.update(goalId, {
    deleted_at: new Date().toISOString(),
    sync_state: 'pending'
  });
  this.syncService.queueDelete('goals', goalId);
}
```

Edit conflict handling: If goal was edited on another device during edit, show warning and allow user to choose which version to keep.

Minute adjustment edge case: If minute is changed, timeline should re-sort events chronologically.

[Source: PRD Epic 5 Story 5.8, Architecture Section 7 Offline-First Architecture]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
