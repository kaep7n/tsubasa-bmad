# Story 5.9: Smart Player Sorting by Frequency

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** the most relevant players at the top of the goal logging list,
**so that** I can log goals faster for active players

## Acceptance Criteria
1. ✅ `PlayerSortingService` tracks player selection frequency
2. ✅ Stores usage count per player in IndexedDB (`player_usage_stats` table)
3. ✅ Increments count each time player selected for goal/assist
4. ✅ Persists across sessions
5. ✅ Sorting algorithm: Current game scorers → Frequency → Alphabetical
6. ✅ Visual indicators: Badge for goal count, "⭐" for frequent players
7. ✅ Sorting updates reactively after each goal
8. ✅ Reset functionality: Clear usage stats at season end
9. ✅ Service tested with mock data
10. ✅ E2E test: Log 3 goals by same player, verify moves to top

## Tasks / Subtasks

- [ ] **Task 1: Create PlayerSortingService** (AC: 1)
  - [ ] Run: `ng generate service core/services/player-sorting`
  - [ ] Methods: trackSelection(playerId), getSortedPlayers(gameId)

- [ ] **Task 2: Create Usage Stats Table** (AC: 2)
  - [ ] IndexedDB schema: player_usage_stats
    - player_id (primary key)
    - usage_count (number, default: 0)
    - last_used_at (timestamp)
  - [ ] Add to Dexie schema

- [ ] **Task 3: Implement Usage Tracking** (AC: 3, 4)
  - [ ] On goal/assist logged:
    - Increment player_usage_stats.usage_count
    - Update last_used_at = new Date()
  - [ ] Persist to IndexedDB
  - [ ] No sync to backend (local-only feature)

- [ ] **Task 4: Implement Sorting Algorithm** (AC: 5)
  - [ ] getSortedPlayers() logic:
    1. Load players who scored in current game (from goals table)
    2. Load player_usage_stats for all players
    3. Sort by:
       - Current game scorers (by scored_at_minute, most recent first)
       - Then by usage_count (descending)
       - Then alphabetically by first_name
  - [ ] Return sorted player array

- [ ] **Task 5: Add Visual Indicators** (AC: 6)
  - [ ] Current game badge: Show goal count next to player name
    - Display: "2 goals" or "1 goal"
  - [ ] Frequent player indicator: "⭐" icon for usage_count > 10
  - [ ] Subtle styling, doesn't overwhelm UI

- [ ] **Task 6: Implement Reactive Updates** (AC: 7)
  - [ ] After goal logged, call getSortedPlayers()
  - [ ] Update player list Signal
  - [ ] List re-renders with new order

- [ ] **Task 7: Add Reset Functionality** (AC: 8)
  - [ ] Settings page: "Reset Player Usage Stats" button
  - [ ] Confirmation dialog: "Clear all player usage data?"
  - [ ] On confirm: DELETE FROM player_usage_stats
  - [ ] Show toast: "Usage stats reset"

- [ ] **Task 8: Write Tests** (AC: 9, 10)
  - [ ] Unit test: Sorting algorithm with mock data
  - [ ] Unit test: Usage count increments correctly
  - [ ] Unit test: Reset clears all stats
  - [ ] E2E test: Log 3 goals by same player
  - [ ] E2E test: Verify player moves to top of list

## Dev Notes

Service location: `/src/app/core/services/player-sorting.service.ts`

Sorting is local-only optimization, not synced to backend. Each coach's device learns their own patterns.

Usage stats schema:
```typescript
interface PlayerUsageStats {
  player_id: string;
  usage_count: number;
  last_used_at: string; // ISO timestamp
}
```

Sorting algorithm:
```typescript
async getSortedPlayers(gameId: string): Promise<Player[]> {
  // 1. Get players who scored in current game
  const currentGameScorers = await this.db.goals
    .where({ game_id: gameId, deleted_at: null })
    .toArray()
    .then(goals => {
      const scorerMap = new Map<string, number>();
      goals.forEach(g => {
        scorerMap.set(g.player_id, (scorerMap.get(g.player_id) || 0) + 1);
      });
      return scorerMap;
    });

  // 2. Get all players with usage stats
  const players = await this.db.players.toArray();
  const usageStats = await this.db.player_usage_stats.toArray();
  const usageMap = new Map(usageStats.map(s => [s.player_id, s.usage_count]));

  // 3. Sort
  return players.sort((a, b) => {
    const aGoals = currentGameScorers.get(a.id) || 0;
    const bGoals = currentGameScorers.get(b.id) || 0;
    if (aGoals !== bGoals) return bGoals - aGoals; // Current game scorers first

    const aUsage = usageMap.get(a.id) || 0;
    const bUsage = usageMap.get(b.id) || 0;
    if (aUsage !== bUsage) return bUsage - aUsage; // Then by frequency

    return a.first_name.localeCompare(b.first_name); // Then alphabetically
  });
}
```

Frequent player threshold: 10+ selections = show star icon.

[Source: PRD Epic 5 Story 5.9, Architecture Section 8 State Management]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
