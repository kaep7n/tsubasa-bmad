# Story 6.5: CSV Export for Player Statistics

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to export player statistics to CSV,
**so that** I can analyze data in Excel or share with league administrators

## Acceptance Criteria
1. ✅ "Export to CSV" button on Player Statistics dashboard
2. ✅ CSV includes: name, jersey, games, goals, assists, attendance %, training
3. ✅ Respects current filters: date range and search
4. ✅ File naming: `tsubasa-player-stats-YYYY-MM-DD.csv`
5. ✅ Encoding: UTF-8 with BOM for Excel compatibility
6. ✅ CSV generation: Client-side using Blob API, triggers download
7. ✅ Empty state handling: Show toast if no data
8. ✅ Offline: works entirely client-side
9. ✅ Unit test: Verify CSV formatting and UTF-8 encoding
10. ✅ E2E test: Export CSV, verify file downloads

## Tasks / Subtasks

- [ ] **Task 1: Add Export Button** (AC: 1)
  - [ ] Button in Player Stats header: "Export to CSV"
  - [ ] Icon: download or spreadsheet
  - [ ] Click triggers export

- [ ] **Task 2: Build CSV Data** (AC: 2, 3)
  - [ ] Header row: "Player Name,Jersey Number,Games Played,Goals Scored,Assists,Attendance Rate,Training Sessions Attended"
  - [ ] Data rows: One per player in current view
  - [ ] Respect active filters (date range, search)

- [ ] **Task 3: Implement File Naming** (AC: 4)
  - [ ] Format: tsubasa-player-stats-YYYY-MM-DD.csv
  - [ ] Use current date for YYYY-MM-DD

- [ ] **Task 4: Handle UTF-8 with BOM** (AC: 5)
  - [ ] Add BOM: `\uFEFF` prefix for Excel compatibility
  - [ ] Encode as UTF-8

- [ ] **Task 5: Generate and Download CSV** (AC: 6)
  - [ ] Use Blob API to create file
  - [ ] Create download link and trigger click
  - [ ] Clean up object URL

- [ ] **Task 6: Handle Empty State** (AC: 7)
  - [ ] Check if data array is empty
  - [ ] Show toast: "No statistics to export"
  - [ ] Don't trigger download

- [ ] **Task 7: Ensure Offline Capability** (AC: 8)
  - [ ] No network requests
  - [ ] All data from IndexedDB
  - [ ] Client-side CSV generation

- [ ] **Task 8: Write Tests** (AC: 9, 10)
  - [ ] Unit test: CSV formatting
  - [ ] Unit test: UTF-8 BOM present
  - [ ] E2E test: Click export, verify download
  - [ ] E2E test: Verify filename format

## Dev Notes

Service location: `/src/app/core/services/csv-export.service.ts`

CSV generation logic:
```typescript
exportPlayerStatsToCSV(players: PlayerStats[]) {
  if (players.length === 0) {
    this.snackBar.open('No statistics to export', 'OK', { duration: 3000 });
    return;
  }

  // Header row
  const header = 'Player Name,Jersey Number,Games Played,Goals Scored,Assists,Attendance Rate,Training Sessions Attended';

  // Data rows
  const rows = players.map(p =>
    `${p.playerName},${p.jerseyNumber},${p.gamesPlayed},${p.goalsScored},${p.assists},${p.attendanceRate},${p.trainingSessionsAttended}`
  );

  // Combine with BOM
  const csv = '\uFEFF' + header + '\n' + rows.join('\n');

  // Create blob and download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `tsubasa-player-stats-${this.formatDate(new Date())}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}

formatDate(date: Date): string {
  return date.toISOString().split('T')[0]; // YYYY-MM-DD
}
```

BOM (Byte Order Mark) `\uFEFF` ensures Excel correctly detects UTF-8 encoding.

CSV escaping: If player names contain commas, wrap in quotes:
```typescript
const escape = (value: string) => value.includes(',') ? `"${value}"` : value;
```

[Source: PRD Epic 6 Story 6.5, Architecture Section 16 User Experience]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
