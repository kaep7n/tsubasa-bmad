# Story 6.8: Game Result Recording (Win/Draw/Loss)

## Status
Ready

## Assigned To
James (Dev Agent)

## Story
**As a** coach,
**I want** to manually record the final game result,
**so that** win/loss statistics are accurate even if opponent score tracking was incomplete

## Acceptance Criteria
1. ✅ "Finalize Game" button appears after timer reaches 90+ minutes
2. ✅ Modal displays: current score, auto-calculated result, manual override option
3. ✅ Finalization updates game record: status='completed', final scores, result, finalized_at
4. ✅ After finalization: Redirect to detail, show "Generate Report" button, stop timer
5. ✅ Goals can still be edited after finalization
6. ✅ Result contributes to team statistics (W-D-L record)
7. ✅ Finalization synced to Supabase
8. ✅ Offline: saved to IndexedDB, synced when online
9. ✅ E2E test: Finalize game, verify result calculated, verify report generation available

## Tasks / Subtasks

- [ ] **Task 1: Add Finalize Game Button** (AC: 1)
  - [ ] Live game screen: Show button when timer >= 90 minutes
  - [ ] Button: "Finalize Game"
  - [ ] Opens finalization modal

- [ ] **Task 2: Build Finalization Modal** (AC: 2)
  - [ ] Display current score: Team X - Y Opponent
  - [ ] Auto-calculate result:
    - Win if team > opponent
    - Draw if team = opponent
    - Loss if team < opponent
  - [ ] Manual override: Editable score fields
  - [ ] Confirmation button: "Confirm & Finalize"

- [ ] **Task 3: Implement Finalization Logic** (AC: 3)
  - [ ] Update game record:
    - status = 'completed'
    - final_score_team = teamScore
    - final_score_opponent = opponentScore
    - result = 'win' | 'draw' | 'loss'
    - finalized_at = new Date()
  - [ ] Save to IndexedDB
  - [ ] Add to sync queue

- [ ] **Task 4: Post-Finalization Behavior** (AC: 4, 5)
  - [ ] Redirect to `/games/:id` (game detail)
  - [ ] Show "Generate Report" button
  - [ ] Stop game timer (disable pause/resume)
  - [ ] Goals remain editable (show edit icons)

- [ ] **Task 5: Update Team Statistics** (AC: 6)
  - [ ] Invalidate stats cache
  - [ ] Recalculate W-D-L record
  - [ ] Include finalized game in aggregations

- [ ] **Task 6: Sync to Backend** (AC: 7, 8)
  - [ ] Add finalization to sync queue
  - [ ] Sync to Supabase when online
  - [ ] Update sync_state = 'pending' → 'synced'

- [ ] **Task 7: Write Tests** (AC: 9)
  - [ ] E2E test: Play game to 90 minutes
  - [ ] E2E test: Tap Finalize, verify modal
  - [ ] E2E test: Confirm finalization
  - [ ] E2E test: Verify result calculated (Win for 3-1)
  - [ ] E2E test: Verify "Generate Report" button visible
  - [ ] E2E test: Edit goal after finalization

## Dev Notes

Component location: `/src/app/features/games/components/finalize-game-modal/`

Result calculation:
```typescript
calculateResult(teamScore: number, opponentScore: number): 'win' | 'draw' | 'loss' {
  if (teamScore > opponentScore) return 'win';
  if (teamScore === opponentScore) return 'draw';
  return 'loss';
}
```

Finalization logic:
```typescript
async finalizeGame() {
  const teamScore = this.countTeamGoals();
  const opponentScore = this.countOpponentGoals();
  const result = this.calculateResult(teamScore, opponentScore);

  await this.db.games.update(this.gameId, {
    status: 'completed',
    final_score_team: teamScore,
    final_score_opponent: opponentScore,
    result: result,
    finalized_at: new Date().toISOString(),
    sync_state: 'pending'
  });

  this.syncService.queueUpdate('games', this.gameId);
  this.router.navigate(['/games', this.gameId]);
}
```

Manual override allows coach to correct score if opponent goals were not tracked accurately during live game.

After finalization, game is marked "completed" but goals remain editable for post-game corrections (e.g., if a goal was missed during live tracking).

[Source: PRD Epic 6 Story 6.8, Architecture Section 8 State Management]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
