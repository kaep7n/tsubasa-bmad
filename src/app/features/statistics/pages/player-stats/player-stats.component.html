<div class="player-stats-container">
  <!-- Header -->
  <div class="stats-header">
    <h1>
      <mat-icon>leaderboard</mat-icon>
      Player Statistics
    </h1>

    <button
      mat-raised-button
      color="primary"
      (click)="exportToCSV()"
      [disabled]="!hasData() || isLoading()"
      matTooltip="Export to CSV"
    >
      <mat-icon>download</mat-icon>
      Export
    </button>
  </div>

  <!-- Filters -->
  <div class="filters">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search Players</mat-label>
      <input
        matInput
        [value]="searchQuery()"
        (input)="onSearchChange($any($event.target).value)"
        placeholder="Search by name..."
      />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="date-range-field">
      <mat-label>Date Range</mat-label>
      <mat-select
        [value]="dateRangeOption()"
        (selectionChange)="onDateRangeChange($event.value)"
      >
        <mat-option value="all">All Time</mat-option>
        <mat-option value="season">This Season</mat-option>
        <mat-option value="month">Last Month</mat-option>
      </mat-select>
      <mat-icon matPrefix>date_range</mat-icon>
    </mat-form-field>
  </div>

  <!-- Loading Spinner -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Calculating statistics...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && !hasData()) {
    <div class="empty-state">
      <mat-icon>sports_soccer</mat-icon>
      <h2>No statistics available</h2>
      <p>Statistics will appear after your first game with recorded player data</p>
    </div>
  }

  <!-- Table -->
  @if (!isLoading() && hasData()) {
    <div class="table-container">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        matSortActive="goals_scored"
        matSortDirection="desc"
        class="stats-table"
      >
        <!-- Player Name Column -->
        <ng-container matColumnDef="player_name">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            class="sticky-column"
            ariaLabel="Sort by player name"
          >
            Player
          </th>
          <td mat-cell *matCellDef="let row" class="sticky-column">
            <div class="player-cell">
              <div class="player-avatar">
                {{ row.player_name.charAt(0).toUpperCase() }}
              </div>
              <span>{{ row.player_name }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Games Played Column -->
        <ng-container matColumnDef="games_played">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            ariaLabel="Sort by games played"
          >
            Games
          </th>
          <td mat-cell *matCellDef="let row">
            {{ row.games_played }}
          </td>
        </ng-container>

        <!-- Goals Scored Column -->
        <ng-container matColumnDef="goals_scored">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            ariaLabel="Sort by goals scored"
          >
            Goals
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="badge-cell">
              <span>{{ row.goals_scored }}</span>
              @if (getGoalsBadgeRank(row.player_id) > 0) {
                <mat-icon
                  [class]="'badge-icon ' + getBadgeColor(getGoalsBadgeRank(row.player_id))"
                  [matTooltip]="
                    getGoalsBadgeRank(row.player_id) === 1
                      ? 'Top Scorer'
                      : getGoalsBadgeRank(row.player_id) === 2
                        ? '2nd Place'
                        : '3rd Place'
                  "
                >
                  {{ getBadgeIcon(getGoalsBadgeRank(row.player_id)) }}
                </mat-icon>
              }
            </div>
          </td>
        </ng-container>

        <!-- Assists Column -->
        <ng-container matColumnDef="assists">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            ariaLabel="Sort by assists"
          >
            Assists
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="badge-cell">
              <span>{{ row.assists }}</span>
              @if (getAssistsBadgeRank(row.player_id) > 0) {
                <mat-icon
                  [class]="'badge-icon ' + getBadgeColor(getAssistsBadgeRank(row.player_id))"
                  [matTooltip]="
                    getAssistsBadgeRank(row.player_id) === 1
                      ? 'Top Assister'
                      : getAssistsBadgeRank(row.player_id) === 2
                        ? '2nd Place'
                        : '3rd Place'
                  "
                >
                  {{ getBadgeIcon(getAssistsBadgeRank(row.player_id)) }}
                </mat-icon>
              }
            </div>
          </td>
        </ng-container>

        <!-- Attendance Rate Column -->
        <ng-container matColumnDef="attendance_rate">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            ariaLabel="Sort by attendance rate"
          >
            Attendance
          </th>
          <td mat-cell *matCellDef="let row">
            <span
              [class]="'attendance-badge ' + getAttendanceClass(row.attendance_rate)"
              [matTooltip]="'Attendance: ' + row.attendance_rate.toFixed(1) + '%'"
            >
              {{ row.attendance_rate.toFixed(1) }}%
            </span>
          </td>
        </ng-container>

        <!-- Training Sessions Column -->
        <ng-container matColumnDef="training_sessions_attended">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            ariaLabel="Sort by training sessions"
          >
            Training
          </th>
          <td mat-cell *matCellDef="let row">
            {{ row.training_sessions_attended }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  }
</div>
